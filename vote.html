<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŠ•ç¥¨</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #222; color: white; }
        h1 { color: #ff5252; margin-bottom: 10px; }
        p { color: #ccc; }
        #vote-list { list-style: none; padding: 0; max-width: 400px; margin: 20px auto; }
        .vote-btn { 
            display: block; width: 100%; padding: 15px; margin: 10px 0; 
            font-size: 18px; background: #2196F3; color: white; 
            border: none; border-radius: 8px; cursor: pointer; 
        }
        .vote-btn:active { background: #1976D2; transform: scale(0.98); }
        .disabled { background: #555 !important; cursor: not-allowed; opacity: 0.6; }
        .abandon-btn { background: #777; margin-top: 30px; font-size: 14px; padding: 10px; }
        #status-msg { margin-top: 20px; font-weight: bold; color: yellow; }
    </style>
</head>
<body>

    <h1>ğŸ‘‰ æŠ•ç¥¨ã‚¿ã‚¤ãƒ </h1>
    <p>å‡¦åˆ‘ã™ã‚‹äººã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>ï¼ˆè‡ªåˆ†ã«ã¯æŠ•ç¥¨ã§ãã¾ã›ã‚“ï¼‰</p>

    <div id="vote-area">
        <div id="vote-list"></div>
        <button class="vote-btn abandon-btn" id="abandon-btn">å¹³å’Œæ‘ã¨ã—ã¦æŠ•ç¥¨ï¼ˆèª°ã‚‚åŠã‚‰ãªã„ï¼‰</button>
    </div>

    <p id="status-msg"></p>

    <script type="module">
        import { db, ref, get, set, update, onValue, ROOM_ID } from './config.js';

        const params = new URLSearchParams(window.location.search);
        const myName = params.get('name');

        const statusMsg = document.getElementById('status-msg');

        // 1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
        get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
            const players = snap.val();
            const list = document.getElementById('vote-list');

            Object.keys(players).forEach(pName => {
                if (pName === myName) return; 

                const btn = document.createElement('button');
                btn.className = 'vote-btn';
                btn.textContent = `${pName} ã«æŠ•ç¥¨`;
                btn.onclick = () => castVote(pName);
                list.appendChild(btn);
            });
        });

        document.getElementById('abandon-btn').addEventListener('click', () => {
             castVote("NO_EXECUTION");
        });

        function castVote(target) {
            if(!confirm(target === "NO_EXECUTION" ? "èª°ã‚‚åŠã‚Šã¾ã›ã‚“ã‹ï¼Ÿ" : `${target}ã•ã‚“ã«æŠ•ç¥¨ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            set(ref(db, `rooms/${ROOM_ID}/votes/${myName}`), target).then(() => {
                document.querySelectorAll('.vote-btn').forEach(b => {
                    b.disabled = true;
                    b.classList.add('disabled');
                });
                statusMsg.textContent = "æŠ•ç¥¨ã—ã¾ã—ãŸã€‚å…¨å“¡ã®æŠ•ç¥¨ã‚’å¾…ã£ã¦ã„ã¾ã™...";
            });
        }

        // 2. å…¨å“¡ã®æŠ•ç¥¨ç›£è¦–
        onValue(ref(db, `rooms/${ROOM_ID}`), (snap) => {
            const data = snap.val();
            if (!data) return;

            const players = Object.keys(data.players || {});
            const votes = data.votes || {};
            const voteCount = Object.keys(votes).length;

            if (voteCount > 0) {
                statusMsg.textContent = `æŠ•ç¥¨æ¸ˆã¿: ${voteCount} / ${players.length} äºº`;
            }

            // å…¨å“¡æŠ•ç¥¨ã—ãŸã‚‰æ¬¡ã¸
            if (voteCount === players.length && data.phase !== 'result') {
                 // â˜…é‡è¦: statusã‚’endedã«ã™ã‚‹ã“ã¨ã§ã€ãƒ­ãƒ“ãƒ¼ã«æˆ»ã£ãŸæ™‚ã®èª¤ä½œå‹•ã‚’é˜²ã
                 update(ref(db, `rooms/${ROOM_ID}`), { 
                     phase: "result",
                     status: "ended"
                 });
            }

            if (data.phase === 'result') {
                window.location.href = `result.html?name=${encodeURIComponent(myName)}`;
            }
        });
    </script>
</body>
</html>
