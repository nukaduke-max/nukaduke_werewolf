<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚²ãƒ¼ãƒ ä¸­</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #222; color: white; }
        h1, h2 { margin: 10px 0; }
        .card { background: #444; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 400px; border: 2px solid #666; }
        .role-text { font-size: 2.5em; font-weight: bold; color: #ff5252; }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ */
        #action-area { background: #333; padding: 15px; margin-top: 20px; border-radius: 8px; border: 1px solid #ff9800; }
        button { font-size: 16px; padding: 10px 20px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
        button:disabled { background: #777; cursor: not-allowed; }
        button.target-btn { background: #2196F3; display: block; width: 80%; margin: 5px auto; }
        
        .hidden { display: none; }
        .log { color: #aaa; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="main-container">
        <h2>ğŸŒ™ å¤œã®ã‚¿ãƒ¼ãƒ³</h2>
        <p>ã‚ãªãŸã®æœ€åˆã®å½¹è·</p>
        
        <div class="card">
            <div id="my-role-display" class="role-text">???</div>
            <p id="wait-msg">ã‚«ãƒ¼ãƒ‰ã‚’ç¢ºèªä¸­...</p>
        </div>

        <div id="action-area" class="hidden">
            <h3 id="action-title">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <p id="action-desc"></p>
            <div id="action-buttons"></div>
        </div>

        <div id="system-message" style="margin-top: 20px; font-weight: bold; color: yellow;"></div>
        
        <button id="next-phase-btn" class="hidden" style="margin-top:30px; background:#555;">è­°è«–ã¸é€²ã‚€ï¼ˆæœªå®Ÿè£…ï¼‰</button>
    </div>

    <script type="module">
        import { db, ref, get, update, onValue, ROOM_ID } from './config.js';

        const params = new URLSearchParams(window.location.search);
        const myName = params.get('name');
        
        let myData = null;
        let hasActed = false; // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¸ˆã¿ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

        // 1. è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç›£è¦–
        onValue(ref(db, `rooms/${ROOM_ID}/players/${myName}`), (snap) => {
            myData = snap.val();
            if (!myData) return;

            // ç”»é¢è¡¨ç¤ºï¼ˆoriginal_roleã‚’è¡¨ç¤ºã—ç¶šã‘ã‚‹ã®ãŒåŸºæœ¬ï¼‰
            document.getElementById('my-role-display').textContent = myData.original_role;
            document.getElementById('wait-msg').textContent = "ã“ã®å½¹è·ã§ã‚²ãƒ¼ãƒ é–‹å§‹ã§ã™";

            // ã¾ã ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ã¦ãŠã‚‰ãšã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªå½¹è·ãªã‚‰UIã‚’è¡¨ç¤º
            if (!hasActed) {
                checkRoleAction(myData.original_role);
            }
        });

        // å½¹è·ã”ã¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®š
        function checkRoleAction(role) {
            const area = document.getElementById('action-area');
            const title = document.getElementById('action-title');
            const desc = document.getElementById('action-desc');
            const btns = document.getElementById('action-buttons');

            // æ—¢ã«UIãŒå‡ºã¦ã„ã‚Œã°ä½•ã‚‚ã—ãªã„
            if (!area.classList.contains('hidden')) return;

            if (role === 'å ã„å¸«') {
                area.classList.remove('hidden');
                title.textContent = "ğŸ”® å ã„ã®é¤¨";
                desc.textContent = "ã€Œèª°ã‹ä¸€äººã€ã‹ã€Œä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰ã€ã‚’å ãˆã¾ã™ã€‚";
                
                // ä¸­å¤®ã‚’å ã†ãƒœã‚¿ãƒ³
                const centerBtn = document.createElement('button');
                centerBtn.textContent = "ğŸ´ ä¸­å¤®ã®2æšã‚’è¦‹ã‚‹";
                centerBtn.onclick = () => actionSeerCenter();
                btns.appendChild(centerBtn);

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ãƒœã‚¿ãƒ³
                createPlayerButtons("ã“ã®äººã‚’å ã†", actionSeerPlayer);

            } else if (role === 'æ€ªç›—') {
                area.classList.remove('hidden');
                title.textContent = "ğŸ± æ€ªç›—ã®äºˆå‘Š";
                desc.textContent = "èª°ã‹ä¸€äººã‹ã‚‰å½¹è·ã‚’ç›—ã¿ã€è‡ªåˆ†ã¨å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚";
                
                createPlayerButtons("ã“ã®äººã®å½¹è·ã‚’ç›—ã‚€", actionThief);
            
            } else if (role === 'äººç‹¼') {
                // äººç‹¼ã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸è¦ã ãŒã€ä»²é–“ã‚’è¡¨ç¤ºã™ã‚‹
                area.classList.remove('hidden');
                title.textContent = "ğŸº äººç‹¼ã®ä»²é–“";
                showWerewolves();
            }
        }

        // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠãƒœã‚¿ãƒ³ã‚’ä½œã‚‹ä¾¿åˆ©é–¢æ•° ---
        function createPlayerButtons(label, callback) {
            const btns = document.getElementById('action-buttons');
            // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å–å¾—ã—ã¦ãƒœã‚¿ãƒ³åŒ–
            get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
                const players = snap.val();
                Object.keys(players).forEach(pName => {
                    if (pName === myName) return; // è‡ªåˆ†ã¯é¸ã¹ãªã„

                    const btn = document.createElement('button');
                    btn.className = "target-btn";
                    btn.textContent = `${pName} (${label})`;
                    btn.onclick = () => callback(pName);
                    btns.appendChild(btn);
                });
            });
        }

        // --- ğŸº äººç‹¼ã®å‡¦ç† ---
        function showWerewolves() {
            get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
                const players = snap.val();
                let partners = [];
                Object.keys(players).forEach(pName => {
                    if (pName !== myName && players[pName].original_role === 'äººç‹¼') {
                        partners.push(pName);
                    }
                });

                const desc = document.getElementById('action-desc');
                if (partners.length > 0) {
                    desc.textContent = `ä»²é–“ã¯ ${partners.join('ã•ã‚“, ')}ã•ã‚“ ã§ã™ã€‚`;
                } else {
                    desc.textContent = "ä»²é–“ã¯ã„ã¾ã›ã‚“ã€‚ã‚ãªãŸã¯å­¤ç‹¬ãªäººç‹¼ã§ã™...";
                    // â€»ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ã¯ã“ã“ã§ä¸­å¤®ãŒè¦‹ã‚Œã‚‹ãŒã€ä»Šå›ã¯çœç•¥
                }
            });
        }

        // --- ğŸ”® å ã„å¸«ã®å‡¦ç†ï¼šä¸­å¤®ã‚’è¦‹ã‚‹ ---
        function actionSeerCenter() {
            if(!confirm("ä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰2æšã‚’ç¢ºèªã—ã¾ã™ã‹ï¼Ÿ")) return;
            
            get(ref(db, `rooms/${ROOM_ID}/centerCards`)).then((snap) => {
                const cards = snap.val(); // ["äººç‹¼", "æ‘äºº"] ã¿ãŸã„ãªé…åˆ—
                const msg = `ä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰ã¯\nã€Œ${cards[0]}ã€ã¨ã€Œ${cards[1]}ã€\nã§ã—ãŸï¼`;
                finishAction(msg);
            });
        }

        // --- ğŸ”® å ã„å¸«ã®å‡¦ç†ï¼šäººã‚’å ã† ---
        function actionSeerPlayer(targetName) {
            if(!confirm(`${targetName}ã•ã‚“ã‚’å ã„ã¾ã™ã‹ï¼Ÿ`)) return;

            // â˜…é‡è¦ï¼šoriginal_role ã‚’è¦‹ã‚‹ï¼
            get(ref(db, `rooms/${ROOM_ID}/players/${targetName}/original_role`)).then((snap) => {
                const resultRole = snap.val();
                const msg = `å ã„çµæœï¼š\n${targetName}ã•ã‚“ã¯\nã€Œ${resultRole}ã€\nã§ã—ãŸï¼`;
                finishAction(msg);
            });
        }

        // --- ğŸ± æ€ªç›—ã®å‡¦ç†ï¼šç›—ã‚€ ---
        function actionThief(targetName) {
            if(!confirm(`æœ¬å½“ã« ${targetName} ã•ã‚“ã‹ã‚‰ç›—ã¿ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚ãªãŸã®å½¹è·ãŒå¤‰ã‚ã‚Šã¾ã™ï¼‰`)) return;

            // ç›¸æ‰‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            get(ref(db, `rooms/${ROOM_ID}/players/${targetName}`)).then((snap) => {
                const targetData = snap.val();
                
                // â˜…ã‚ãªãŸã®ç†è«–é€šã‚Šã®å…¥ã‚Œæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
                // 1. ç›¸æ‰‹ã® original_role ã‚’å–å¾—ï¼ˆã“ã‚ŒãŒè‡ªåˆ†ãŒãªã‚‹å½¹è·ï¼‰
                // 2. ç›¸æ‰‹ã® team ã‚’å–å¾—ï¼ˆè‡ªåˆ†ãŒãã®é™£å–¶ã«ãªã‚‹ï¼‰
                // 3. ç›¸æ‰‹ã¯å¼·åˆ¶çš„ã« team=0 (æ‘äººå´) ã«ãªã‚‹

                const updates = {};
                
                // è‡ªåˆ†ã‚’æ›¸ãæ›ãˆ
                updates[`players/${myName}/role`] = `æ€ªç›—(å…ƒ${targetData.original_role})`;
                updates[`players/${myName}/team`] = targetData.team; 

                // ç›¸æ‰‹ã‚’æ›¸ãæ›ãˆ
                updates[`players/${targetName}/role`] = `${targetData.original_role}(ç›—ã¾ã‚ŒãŸ)`;
                updates[`players/${targetName}/team`] = 0; // ç›—ã¾ã‚ŒãŸã‚‰å¸‚æ°‘å´

                // å®Ÿè¡Œï¼
                update(ref(db, `rooms/${ROOM_ID}`), updates).then(() => {
                    const msg = `ç›—ã¿æˆåŠŸï¼\nã‚ãªãŸã¯ã€Œ${targetData.original_role}ã€ã«ãªã‚Šã¾ã—ãŸã€‚\nï¼ˆé™£å–¶ã‚‚ç§»å‹•ã—ã¾ã—ãŸï¼‰`;
                    finishAction(msg);
                });
            });
        }

        // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†å‡¦ç† ---
        function finishAction(message) {
            hasActed = true;
            document.getElementById('action-area').classList.add('hidden'); // ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
            
            const sysMsg = document.getElementById('system-message');
            sysMsg.innerText = message;
            alert(message);
        }

    </script>
</body>
</html>
