<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¯ãƒ³ãƒŠã‚¤ãƒˆäººç‹¼ï¼ˆã‚²ãƒ¼ãƒ ä¸­ï¼‰</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #2c3e50; color: white; }
        h1 { margin: 10px 0; font-size: 1.5em; }
        .card { background: white; color: black; padding: 15px; margin: 10px auto; border-radius: 8px; width: 80%; max-width: 300px; }
        .action-area { margin-top: 20px; border-top: 1px solid #7f8c8d; padding-top: 20px; }
        button { font-size: 16px; padding: 10px 20px; margin: 5px; border-radius: 5px; border: none; cursor: pointer; }
        button.target { background-color: #e67e22; color: white; display: block; width: 80%; margin: 10px auto; }
        button.next { background-color: #27ae60; color: white; font-weight: bold; margin-top: 30px; }
        .result-box { background: #f1c40f; color: black; padding: 10px; margin: 10px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <h1 id="header-title">ğŸŒ™ å¤œã®ã‚¿ãƒ¼ãƒ³</h1>
    <p id="welcome-msg">...</p>

    <div class="card">
        <p>ã‚ãªãŸã®å½¹è·</p>
        <h2 id="my-role" style="font-size: 2em; color: #e74c3c;">ç¢ºèªä¸­...</h2>
    </div>

    <div id="action-area" class="action-area hidden">
        <p id="instruction-text">è¡Œå‹•ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <div id="buttons-container"></div>
        <div id="action-result" class="hidden"></div>
    </div>

    <p id="debug-log" style="font-size:0.7em; color:#95a5a6; margin-top:50px;"></p>

    <script type="module">
        import { db, ref, get, update, onValue, ROOM_ID } from './config.js';

        const params = new URLSearchParams(window.location.search);
        const myName = params.get('name');
        const logArea = document.getElementById('debug-log');

        // åå‰ãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
        if (!myName) {
            document.body.innerHTML = "<h1>ã‚¨ãƒ©ãƒ¼: åå‰ãŒã‚ã‚Šã¾ã›ã‚“</h1>";
        } else {
            document.getElementById('welcome-msg').textContent = `${myName}ã•ã‚“`;
            initGame();
        }

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            // è‡ªåˆ†ã®æƒ…å ±ã‚’ç›£è¦–
            onValue(ref(db, `rooms/${ROOM_ID}/players/${myName}`), (snap) => {
                const data = snap.val();
                if (data && data.role) {
                    document.getElementById('my-role').textContent = data.role;
                    setupAction(data.role); // å½¹è·ã”ã¨ã®ç”»é¢ã‚’ä½œã‚‹
                } else {
                    logArea.textContent = "å½¹è·ãƒ‡ãƒ¼ã‚¿å—ä¿¡å¾…ã¡...";
                }
            });
        }

        // å½¹è·ã”ã¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š
        function setupAction(role) {
            const container = document.getElementById('buttons-container');
            const instruction = document.getElementById('instruction-text');
            const area = document.getElementById('action-area');
            area.classList.remove('hidden');
            container.innerHTML = ""; // ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢

            // ã™ã§ã«è¡Œå‹•æ¸ˆã¿ãªã‚‰è¡¨ç¤ºã—ãªã„ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
            if (document.getElementById('action-result').innerHTML !== "") return;

            if (role === "æ‘äºº") {
                instruction.textContent = "æ‘äººã¯å¤œã®é–“ã€ä½•ã‚‚ã§ãã¾ã›ã‚“ã€‚";
            } 
            else if (role === "äººç‹¼") {
                instruction.textContent = "ä»²é–“ã®äººç‹¼ã‚’ç¢ºèªã—ã¾ã™...";
                checkWerewolves();
            } 
            else if (role === "å ã„å¸«") {
                instruction.textContent = "å ã†å¯¾è±¡ã‚’é¸ã‚“ã§ãã ã•ã„";
                // ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒœã‚¿ãƒ³
                createPlayerButtons((targetName) => {
                    seeRole(targetName);
                });
                // ä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                const btn = document.createElement('button');
                btn.className = "target";
                btn.textContent = "ä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹";
                btn.onclick = () => seeCenter();
                container.appendChild(btn);
            } 
            else if (role === "æ€ªç›—") {
                instruction.textContent = "äº¤æ›ã™ã‚‹ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„";
                createPlayerButtons((targetName) => {
                    stealRole(targetName);
                });
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹ä¾¿åˆ©é–¢æ•°
        function createPlayerButtons(callback) {
            get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
                const players = snap.val();
                Object.keys(players).forEach(pName => {
                    if (pName !== myName) { // è‡ªåˆ†ä»¥å¤–
                        const btn = document.createElement('button');
                        btn.className = "target";
                        btn.textContent = `${pName}ã‚’å ã†/ç›—ã‚€`;
                        btn.onclick = () => callback(pName);
                        document.getElementById('buttons-container').appendChild(btn);
                    }
                });
            });
        }

        // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç† ---

        // äººç‹¼: ä»²é–“ã‚’è¦‹ã‚‹
        function checkWerewolves() {
            get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
                const players = snap.val();
                let wolves = [];
                Object.keys(players).forEach(p => {
                    if (players[p].role === "äººç‹¼" && p !== myName) wolves.push(p);
                });
                
                const resultBox = document.getElementById('action-result');
                resultBox.classList.remove('hidden');
                if (wolves.length > 0) {
                    resultBox.innerHTML = `ä»²é–“: ${wolves.join(", ")}`;
                } else {
                    resultBox.innerHTML = "ä»²é–“ã¯ã„ã¾ã›ã‚“ï¼ˆå­¤ç‹¬ãªäººç‹¼ï¼‰";
                }
            });
        }

        // å ã„å¸«: èª°ã‹ã‚’è¦‹ã‚‹
        function seeRole(targetName) {
            get(ref(db, `rooms/${ROOM_ID}/players/${targetName}/role`)).then((snap) => {
                showResult(`${targetName} ã¯ã€${snap.val()}ã€‘ã§ã—ãŸ`);
            });
        }

        // å ã„å¸«: ä¸­å¤®ã‚’è¦‹ã‚‹
        function seeCenter() {
            get(ref(db, `rooms/${ROOM_ID}/centerCards`)).then((snap) => {
                const cards = snap.val();
                showResult(`ä¸­å¤®: ã€${cards[0]}ã€‘ã¨ã€${cards[1]}ã€‘`);
            });
        }

        // æ€ªç›—: äº¤æ›ã™ã‚‹
        function stealRole(targetName) {
            // 1. ç›¸æ‰‹ã®å½¹è·ã‚’å–å¾—
            const targetPath = `rooms/${ROOM_ID}/players/${targetName}/role`;
            const myPath = `rooms/${ROOM_ID}/players/${myName}/role`;

            get(ref(db, targetPath)).then((snap) => {
                const targetRole = snap.val();
                
                // 2. è‡ªåˆ†ã®å½¹è·(æ€ªç›—)ã¨äº¤æ›
                const updates = {};
                updates[targetPath] = "æ€ªç›—"; // ç›¸æ‰‹ã‚’æ€ªç›—ã«
                updates[myPath] = targetRole; // è‡ªåˆ†ã¯ç›¸æ‰‹ã®å½¹è·ã«

                update(ref(db), updates).then(() => {
                    showResult(`ç›—ã‚“ã å½¹è·: ã€${targetRole}ã€‘<br>(ã‚ãªãŸã¯ä»Šã‹ã‚‰${targetRole}ã§ã™)`);
                    // ç”»é¢ã®è¡¨ç¤ºã‚‚æ›´æ–°
                    document.getElementById('my-role').textContent = targetRole; 
                });
            });
        }

        // çµæœè¡¨ç¤ºï¼†ãƒœã‚¿ãƒ³æ¶ˆå»
        function showResult(html) {
            const box = document.getElementById('action-result');
            box.innerHTML = html;
            box.classList.remove('hidden');
            document.getElementById('buttons-container').innerHTML = ""; // ãƒœã‚¿ãƒ³ã‚’éš ã™
            document.getElementById('instruction-text').textContent = "è¡Œå‹•å®Œäº†";
        }

    </script>
</body>
</html>
