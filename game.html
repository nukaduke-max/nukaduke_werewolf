<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚²ãƒ¼ãƒ ä¸­</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #222; color: white; }
        .card { background: #444; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 400px; border: 2px solid #666; }
        .role-text { font-size: 2.5em; font-weight: bold; color: #ff5252; }
        
        #action-area { background: #333; padding: 15px; margin-top: 20px; border-radius: 8px; border: 1px solid #ff9800; }
        button { font-size: 16px; padding: 12px 24px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; width: 80%; max-width: 300px;}
        button:disabled { background: #777; cursor: not-allowed; }
        button.target-btn { background: #2196F3; width: 90%; margin: 5px auto; display: block; }
        
        .hidden { display: none; }
        #timer-display { font-size: 3em; font-weight: bold; color: yellow; margin: 20px 0; }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="night-phase">
            <h2>ğŸŒ™ å¤œã®ã‚¿ãƒ¼ãƒ³</h2>
            <p>ã‚ãªãŸã®æœ€åˆã®å½¹è·</p>
            <div class="card">
                <div id="my-role-display" class="role-text">???</div>
                <p id="wait-msg">ã‚«ãƒ¼ãƒ‰ã‚’ç¢ºèªä¸­...</p>
            </div>

            <div id="action-area" class="hidden">
                <h3 id="action-title">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                <p id="action-desc"></p>
                <div id="action-buttons"></div>
            </div>

            <div id="waiting-area" class="hidden">
                <h3 style="color: #4CAF50;">âœ… æº–å‚™å®Œäº†</h3>
                <p>ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™...<br>(ç”»é¢ã¯ãã®ã¾ã¾ã§ãŠå¾…ã¡ãã ã•ã„)</p>
            </div>
        </div>

        <div id="day-phase" class="hidden">
            <h2>â˜€ï¸ è­°è«–ã‚¿ã‚¤ãƒ </h2>
            <div id="timer-display">00:00</div>
            <p>æ€ªç›—ã¯èª°ã ï¼ï¼Ÿäººç‹¼ã‚’æ¢ã—å‡ºã›ï¼</p>
            <p id="my-current-role-memo" style="color:gray; font-size:0.8em;">(ã‚ãªãŸã®åˆæœŸå½¹è·: <span id="memo-role"></span>)</p>
        </div>
    </div>

    <script type="module">
        import { db, ref, get, update, onValue, ROOM_ID } from './config.js';

        const params = new URLSearchParams(window.location.search);
        const myName = params.get('name');
        
        let myData = null;
        let isReady = false;
        let timerInterval = null;

        // 1. è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç›£è¦–
        onValue(ref(db, `rooms/${ROOM_ID}/players/${myName}`), (snap) => {
            myData = snap.val();
            if (!myData) return;

            // åˆæœŸå½¹è·ã‚’è¡¨ç¤º
            document.getElementById('my-role-display').textContent = myData.original_role;
            document.getElementById('memo-role').textContent = myData.original_role;
            document.getElementById('wait-msg').textContent = "ã“ã®å½¹è·ã§ã‚²ãƒ¼ãƒ é–‹å§‹ã§ã™";

            // ã¾ã æº–å‚™å®Œäº†ã—ã¦ãŠã‚‰ãšã€ã‹ã¤å¤œãƒ•ã‚§ãƒ¼ã‚ºãªã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”»é¢ã‚’å‡ºã™
            // (ãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–: isReadyãŒFirebaseå´ã§trueãªã‚‰å¾…æ©Ÿç”»é¢ã¸)
            if (myData.isReady) {
                showWaiting();
            } else {
                checkRoleAction(myData.original_role);
            }
        });

        // 2. ã‚²ãƒ¼ãƒ å…¨ä½“ã®é€²è¡Œã‚’ç›£è¦–ï¼ˆå¤œâ†’æ˜¼ã®åˆ‡ã‚Šæ›¿ãˆï¼‰
        onValue(ref(db, `rooms/${ROOM_ID}`), (snap) => {
            const roomData = snap.val();
            if (!roomData) return;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œdiscussionï¼ˆè­°è«–ï¼‰ã€ã«ãªã£ãŸã‚‰ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
            if (roomData.status === 'discussion') {
                startDayPhase(roomData.endTime);
            } 
            // ã¾ã ã€Œplayingï¼ˆå¤œï¼‰ã€ãªã‚‰ã€å…¨å“¡æº–å‚™ã§ããŸã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†è€…å½¹ã®å‡¦ç†ï¼‰
            else if (roomData.status === 'playing') {
                checkAllReady(roomData);
            }
        });

        // å½¹è·ã”ã¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
        function checkRoleAction(role) {
            const area = document.getElementById('action-area');
            const title = document.getElementById('action-title');
            const desc = document.getElementById('action-desc');
            const btns = document.getElementById('action-buttons');

            // æ—¢ã«è¡¨ç¤ºæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (!area.classList.contains('hidden')) return;

            area.classList.remove('hidden');
            btns.innerHTML = ""; // ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢

            if (role === 'å ã„å¸«') {
                title.textContent = "ğŸ”® å ã„ã®é¤¨";
                desc.textContent = "ã€Œèª°ã‹ä¸€äººã€ã‹ã€Œä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰ã€ã‚’å ã£ã¦ãã ã•ã„ã€‚";
                
                const centerBtn = document.createElement('button');
                centerBtn.textContent = "ğŸ´ ä¸­å¤®ã®2æšã‚’è¦‹ã‚‹";
                centerBtn.onclick = () => actionSeerCenter();
                btns.appendChild(centerBtn);

                createPlayerButtons("ã“ã®äººã‚’å ã†", actionSeerPlayer);

            } else if (role === 'æ€ªç›—') {
                title.textContent = "ğŸ± æ€ªç›—ã®äºˆå‘Š";
                desc.textContent = "èª°ã‹ä¸€äººã‹ã‚‰å½¹è·ã‚’ç›—ã‚€ã‹ã€ç›—ã¾ãªã„ã‹é¸ã¹ã¾ã™ã€‚";
                
                createPlayerButtons("ã“ã®äººã‹ã‚‰ç›—ã‚€", actionThief);
                
                // æ€ªç›—ã¯ã€Œç›—ã¾ãªã„ã€é¸æŠè‚¢ã‚‚ä½œã£ã¦ãŠã
                const noStealBtn = document.createElement('button');
                noStealBtn.style.backgroundColor = "#777";
                noStealBtn.textContent = "ç›—ã¾ãªã„ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰";
                noStealBtn.onclick = () => finishAction("ä½•ã‚‚ç›—ã¿ã¾ã›ã‚“ã§ã—ãŸã€‚");
                btns.appendChild(noStealBtn);
            
            } else if (role === 'äººç‹¼') {
                title.textContent = "ğŸº äººç‹¼ã®ç¢ºèª";
                showWerewolves(); // ä»²é–“ã‚’è¡¨ç¤º
                addConfirmButton("ç¢ºèªã—ã¾ã—ãŸ"); // å®Œäº†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            } else {
                // æ‘äººã‚„ãã®ä»–
                title.textContent = "ğŸ‘± ç¢ºèª";
                desc.textContent = "ç‰¹ã«å¤œã®è¡Œå‹•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
                addConfirmButton("ç¢ºèªã—ã¾ã—ãŸ");
            }
        }

        // --- å…±é€š: ç¢ºèªå®Œäº†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹é–¢æ•° ---
        function addConfirmButton(text) {
            const btns = document.getElementById('action-buttons');
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.onclick = () => finishAction("æº–å‚™å®Œäº†ã—ã¾ã—ãŸã€‚");
            btns.appendChild(btn);
        }

        // --- ğŸº äººç‹¼ã®ä»²é–“è¡¨ç¤º ---
        function showWerewolves() {
            get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
                const players = snap.val();
                let partners = [];
                Object.keys(players).forEach(pName => {
                    if (pName !== myName && players[pName].original_role === 'äººç‹¼') {
                        partners.push(pName);
                    }
                });
                const desc = document.getElementById('action-desc');
                if (partners.length > 0) {
                    desc.textContent = `ä»²é–“ã¯ ${partners.join('ã•ã‚“, ')}ã•ã‚“ ã§ã™ã€‚`;
                } else {
                    desc.textContent = "ä»²é–“ã¯ã„ã¾ã›ã‚“ã€‚å˜ç‹¬ã®äººç‹¼ã§ã™ã€‚";
                }
            });
        }

        // --- ğŸ”® å ã„å¸«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
        function actionSeerCenter() {
            get(ref(db, `rooms/${ROOM_ID}/centerCards`)).then((snap) => {
                const cards = snap.val();
                alert(`ä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰ã¯\nã€Œ${cards[0]}ã€ã¨ã€Œ${cards[1]}ã€\nã§ã—ãŸï¼`);
                finishAction("å ã„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
            });
        }
        function actionSeerPlayer(targetName) {
            get(ref(db, `rooms/${ROOM_ID}/players/${targetName}/original_role`)).then((snap) => {
                const r = snap.val();
                alert(`${targetName}ã•ã‚“ã¯\nã€Œ${r}ã€\nã§ã—ãŸï¼`);
                finishAction("å ã„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
            });
        }

        // --- ğŸ± æ€ªç›—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
        function actionThief(targetName) {
            if(!confirm(`${targetName}ã‹ã‚‰ç›—ã¿ã¾ã™ã‹ï¼Ÿ`)) return;
            get(ref(db, `rooms/${ROOM_ID}/players/${targetName}`)).then((snap) => {
                const targetData = snap.val();
                const updates = {};
                
                // å…¥ã‚Œæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
                updates[`players/${myName}/role`] = `æ€ªç›—(å…ƒ${targetData.original_role})`;
                updates[`players/${myName}/team`] = targetData.team; 
                updates[`players/${targetName}/role`] = `${targetData.original_role}(ç›—ã¾ã‚ŒãŸ)`;
                updates[`players/${targetName}/team`] = 0; // æ‘äººå´ã¸

                update(ref(db, `rooms/${ROOM_ID}`), updates).then(() => {
                    alert(`ç›—ã¿æˆåŠŸï¼\nã‚ãªãŸã¯ã€Œ${targetData.original_role}ã€ã«ãªã‚Šã¾ã—ãŸã€‚`);
                    finishAction("ç›—ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
                });
            });
        }

        // --- å…±é€š: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†å‡¦ç† ---
        function finishAction(msg) {
            // Firebaseã«ã€Œæº–å‚™å®Œäº†(isReady: true)ã€ã‚’é€ä¿¡
            update(ref(db, `rooms/${ROOM_ID}/players/${myName}`), {
                isReady: true
            });
            showWaiting();
        }

        function showWaiting() {
            document.getElementById('action-area').classList.add('hidden');
            document.getElementById('waiting-area').classList.remove('hidden');
        }

        // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠãƒœã‚¿ãƒ³ä½œæˆ ---
        function createPlayerButtons(label, callback) {
            const btns = document.getElementById('action-buttons');
            get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
                Object.keys(snap.val()).forEach(pName => {
                    if (pName === myName) return;
                    const btn = document.createElement('button');
                    btn.className = "target-btn";
                    btn.textContent = `${pName} (${label})`;
                    btn.onclick = () => callback(pName);
                    btns.appendChild(btn);
                });
            });
        }

        // --- ç®¡ç†è€…å‡¦ç†: å…¨å“¡æº–å‚™OKã‹ãƒã‚§ãƒƒã‚¯ ---
        function checkAllReady(roomData) {
            const players = roomData.players;
            if (!players) return;

            // å…¨å“¡ã® isReady ãŒ true ã‹ç¢ºèª
            const allReady = Object.values(players).every(p => p.isReady === true);
            
            // å…¨å“¡OKãªã‚‰ã€æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸ï¼ˆâ€»é‡è¤‡å®Ÿè¡Œã‚’é˜²ããŸã‚endTimeãŒãªã„å ´åˆã®ã¿æ›¸ãè¾¼ã‚€ï¼‰
            if (allReady && !roomData.endTime) {
                // çµ‚äº†æ™‚åˆ»ã‚’è¨ˆç®— (ç¾åœ¨æ™‚åˆ» + è¨­å®šæ™‚é–“ç§’)
                const duration = roomData.gameTime || 180;
                const endTime = Date.now() + (duration * 1000);

                update(ref(db, `rooms/${ROOM_ID}`), {
                    status: 'discussion',
                    endTime: endTime
                });
            }
        }

        // --- â˜€ï¸ è­°è«–ãƒ•ã‚§ãƒ¼ã‚ºã®é–‹å§‹ ---
        function startDayPhase(endTime) {
            document.getElementById('night-phase').classList.add('hidden');
            document.getElementById('day-phase').classList.remove('hidden');

            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = Date.now();
                const diff = endTime - now;

                if (diff <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timer-display').textContent = "00:00";
                    document.getElementById('timer-display').style.color = "red";
                    alert("è­°è«–çµ‚äº†ï¼æŠ•ç¥¨ã¸ç§»ã‚Šã¾ã™ã€‚");
                    // ã“ã“ã«æŠ•ç¥¨ç”»é¢ã¸ã®é·ç§»å‡¦ç†ãªã©ã‚’æ›¸ã
                } else {
                    // åˆ†:ç§’ ã®å½¢å¼ã«ã™ã‚‹
                    const m = Math.floor(diff / 60000);
                    const s = Math.floor((diff % 60000) / 1000);
                    document.getElementById('timer-display').textContent = 
                        `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

    </script>
</body>
</html>
