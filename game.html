<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚²ãƒ¼ãƒ ä¸­</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #222; color: white; }
        .card { background: #444; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 400px; border: 2px solid #666; }
        .role-text { font-size: 2.5em; font-weight: bold; color: #ff5252; }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»å¾…æ©Ÿã‚¨ãƒªã‚¢ */
        .area-box { background: #333; padding: 15px; margin-top: 20px; border-radius: 8px; border: 1px solid #ff9800; }
        .hidden { display: none !important; }

        /* ãƒœã‚¿ãƒ³ */
        button { font-size: 16px; padding: 10px 20px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
        button:disabled { background: #777; cursor: not-allowed; }
        button.target-btn { background: #2196F3; display: block; width: 80%; margin: 5px auto; }
        button.finish-btn { background: #E91E63; font-weight: bold; width: 100%; font-size: 1.2em; margin-top: 15px; }

        /* ã‚¿ã‚¤ãƒãƒ¼ */
        #timer-display { font-size: 4em; font-weight: bold; color: #00e676; margin: 20px 0; }
        .vote-link { font-size: 1.2em; color: #4fc3f7; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="night-phase">
            <h2>ğŸŒ™ å¤œã®ã‚¿ãƒ¼ãƒ³</h2>
            <p>ã‚ãªãŸã®æœ€åˆã®å½¹è·</p>
            <div class="card">
                <div id="my-role-display" class="role-text">???</div>
            </div>

            <div id="action-area" class="area-box hidden">
                <h3 id="action-title">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                <p id="action-desc"></p>
                <div id="action-buttons"></div>
            </div>

            <div id="wait-area" class="area-box">
                <p id="wait-msg">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒçµ‚ã‚ã£ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
                <button id="finish-btn" class="finish-btn">ç¢ºèªãƒ»è¡Œå‹•å®Œäº†</button>
                <p id="ready-count" style="color:yellow; margin-top:10px;">å¾…æ©Ÿä¸­: - / -</p>
            </div>
        </div>

        <div id="discussion-phase" class="hidden">
            <h2>â˜€ï¸ æœï¼šè­°è«–ã‚¿ã‚¤ãƒ </h2>
            <p>æ€ªã—ã„äººã‚’æ¢ã—å‡ºã—ã¦ãã ã•ã„ï¼</p>
            <div id="timer-display">00:00</div>
            <p>æ™‚é–“ãŒæ¥ãŸã‚‰æŠ•ç¥¨ç”»é¢ã¸ç§»å‹•ã—ã¾ã™</p>
        </div>
    </div>

    <script type="module">
        import { db, ref, get, update, onValue, ROOM_ID } from './config.js';

        const params = new URLSearchParams(window.location.search);
        const myName = params.get('name');
        
        let myData = null;
        let hasActed = false; // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¸ˆã¿ãƒ•ãƒ©ã‚°
        let timerInterval = null;

        // --- 1. ãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–é–‹å§‹ ---
        
        // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç›£è¦–
        onValue(ref(db, `rooms/${ROOM_ID}/players/${myName}`), (snap) => {
            myData = snap.val();
            if (!myData) return;
            
            // å½¹è·è¡¨ç¤º
            document.getElementById('my-role-display').textContent = myData.original_role;
            
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³UIã®è¡¨ç¤ºåˆ¶å¾¡
            // (ã¾ã å®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãŠã‚‰ãšã€ã‹ã¤ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªå½¹è·ãªã‚‰)
            if (!myData.actDone && !hasActed) {
                checkRoleAction(myData.original_role);
            }

            // æ—¢ã«å®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã„ã‚‹å ´åˆ
            if (myData.actDone) {
                document.getElementById('finish-btn').disabled = true;
                document.getElementById('finish-btn').textContent = "ä»–ã®äººã‚’å¾…ã£ã¦ã„ã¾ã™...";
                document.getElementById('action-area').classList.add('hidden'); // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³éš ã™
            }
        });

        // éƒ¨å±‹å…¨ä½“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦– (è­°è«–é–‹å§‹ç”¨)
        onValue(ref(db, `rooms/${ROOM_ID}`), (snap) => {
            const roomData = snap.val();
            if (!roomData) return;

            // â– å…¨å“¡ã®æº–å‚™çŠ¶æ³ãƒã‚§ãƒƒã‚¯ (å¤œãƒ•ã‚§ãƒ¼ã‚ºã®ã¿)
            if (roomData.players && (!roomData.phase || roomData.phase === 'night')) {
                const players = Object.values(roomData.players);
                const total = players.length;
                const done = players.filter(p => p.actDone).length;
                
                document.getElementById('ready-count').textContent = `æº–å‚™å®Œäº†: ${done} / ${total} äºº`;

                // ã‚‚ã—ã€Œå…¨å“¡å®Œäº†ã€ã‹ã¤ã€Œè‡ªåˆ†ãŒæœ€å¾Œã®1äººã€ãªã‚‰ã€ãƒ•ã‚§ãƒ¼ã‚ºã‚’å¤‰ãˆã‚‹
                // (é‡è¤‡å‡¦ç†ã‚’é˜²ããŸã‚ã€actDoneãŒtrueã®è‡ªåˆ†è‡ªèº«ãŒãƒˆãƒªã‚¬ãƒ¼ã«ãªã‚‹)
                if (done === total && myData && myData.actDone) {
                    // è­°è«–çµ‚äº†æ™‚é–“ã‚’è¨ˆç®— (ç¾åœ¨æ™‚åˆ» + è¨­å®šç§’æ•°)
                    const gameTime = roomData.gameTime || 180;
                    const endTime = Date.now() + (gameTime * 1000);

                    update(ref(db, `rooms/${ROOM_ID}`), {
                        phase: "discussion",
                        endTime: endTime
                    });
                }
            }

            // â– è­°è«–ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®åˆ‡ã‚Šæ›¿ãˆ
            if (roomData.phase === 'discussion') {
                startDiscussion(roomData.endTime);
            }
        });


        // --- 2. ãƒœã‚¿ãƒ³å‡¦ç† ---

        // ã€Œç¢ºèªãƒ»è¡Œå‹•å®Œäº†ã€ãƒœã‚¿ãƒ³
        document.getElementById('finish-btn').addEventListener('click', () => {
            // Firebaseã«ã€Œçµ‚ã‚ã£ãŸã‚ˆã€ã¨æ›¸ãè¾¼ã‚€
            update(ref(db, `rooms/${ROOM_ID}/players/${myName}`), {
                actDone: true
            });
        });

        // --- 3. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ (å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) ---
        function checkRoleAction(role) {
            const area = document.getElementById('action-area');
            const title = document.getElementById('action-title');
            const desc = document.getElementById('action-desc');
            const btns = document.getElementById('action-buttons');

            // æ—¢ã«è¡¨ç¤ºæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (!area.classList.contains('hidden')) return;

            if (role === 'å ã„å¸«') {
                area.classList.remove('hidden');
                title.textContent = "ğŸ”® å ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³";
                desc.textContent = "å ã†å¯¾è±¡ã‚’é¸ã‚“ã§ãã ã•ã„";
                
                const centerBtn = document.createElement('button');
                centerBtn.textContent = "ğŸ´ ä¸­å¤®ã‚’è¦‹ã‚‹";
                centerBtn.onclick = () => actionSeerCenter();
                btns.appendChild(centerBtn);
                createPlayerButtons("å ã†", actionSeerPlayer);

            } else if (role === 'æ€ªç›—') {
                area.classList.remove('hidden');
                title.textContent = "ğŸ± æ€ªç›—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³";
                desc.textContent = "ç›—ã‚€å¯¾è±¡ã‚’é¸ã‚“ã§ãã ã•ã„";
                createPlayerButtons("ç›—ã‚€", actionThief);
            
            } else if (role === 'äººç‹¼') {
                area.classList.remove('hidden');
                title.textContent = "ğŸº ä»²é–“ç¢ºèª";
                showWerewolves();
            }
        }

        // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°é–¢æ•° ---
        function createPlayerButtons(label, callback) {
            const btns = document.getElementById('action-buttons');
            get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
                const players = snap.val();
                Object.keys(players).forEach(pName => {
                    if (pName === myName) return;
                    const btn = document.createElement('button');
                    btn.className = "target-btn";
                    btn.textContent = `${pName} ã‚’${label}`;
                    btn.onclick = () => callback(pName);
                    btns.appendChild(btn);
                });
            });
        }

        function showWerewolves() {
            get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
                const players = snap.val();
                let partners = [];
                Object.keys(players).forEach(pName => {
                    if (pName !== myName && players[pName].original_role === 'äººç‹¼') {
                        partners.push(pName);
                    }
                });
                document.getElementById('action-desc').innerText = 
                    partners.length > 0 ? `ä»²é–“: ${partners.join(', ')}` : "ä»²é–“ã¯ã„ã¾ã›ã‚“ï¼ˆå˜ç‹¬ï¼‰";
            });
        }

        function actionSeerCenter() {
            if(!confirm("ä¸­å¤®ã‚’è¦‹ã¾ã™ã‹ï¼Ÿ")) return;
            get(ref(db, `rooms/${ROOM_ID}/centerCards`)).then((snap) => {
                const c = snap.val();
                alert(`ä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰: [${c[0]}] [${c[1]}]`);
                hasActed = true; // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¸ˆã¿ãƒ•ãƒ©ã‚°
                document.getElementById('action-buttons').innerHTML = ""; // ãƒœã‚¿ãƒ³æ¶ˆã™
                document.getElementById('action-desc').textContent = "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã§ç¢ºå®šã—ã¦ãã ã•ã„ã€‚";
            });
        }

        function actionSeerPlayer(target) {
            if(!confirm(`${target}ã•ã‚“ã‚’å ã„ã¾ã™ã‹ï¼Ÿ`)) return;
            get(ref(db, `rooms/${ROOM_ID}/players/${target}/original_role`)).then((snap) => {
                alert(`${target}ã•ã‚“ã¯ã€Œ${snap.val()}ã€ã§ã—ãŸ`);
                hasActed = true;
                document.getElementById('action-buttons').innerHTML = "";
                document.getElementById('action-desc').textContent = "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã§ç¢ºå®šã—ã¦ãã ã•ã„ã€‚";
            });
        }

        function actionThief(target) {
            if(!confirm(`${target}ã•ã‚“ã‹ã‚‰ç›—ã¿ã¾ã™ã‹ï¼Ÿ`)) return;
            get(ref(db, `rooms/${ROOM_ID}/players/${target}`)).then((snap) => {
                const tData = snap.val();
                const updates = {};
                
                // ãƒ‡ãƒ¼ã‚¿ã®å…¥ã‚Œæ›¿ãˆï¼ˆä»¥å‰ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                updates[`players/${myName}/role`] = `æ€ªç›—(å…ƒ${tData.original_role})`;
                updates[`players/${myName}/team`] = tData.team;
                updates[`players/${target}/role`] = `${tData.original_role}(ç›—ã¾ã‚ŒãŸ)`;
                updates[`players/${target}/team`] = 0;

                update(ref(db, `rooms/${ROOM_ID}`), updates).then(() => {
                    alert(`ç›—ã¿ã¾ã—ãŸï¼ã‚ãªãŸã¯ã€Œ${tData.original_role}ã€ã«ãªã‚Šã¾ã—ãŸã€‚`);
                    hasActed = true;
                    document.getElementById('action-buttons').innerHTML = "";
                    document.getElementById('action-desc').textContent = "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã§ç¢ºå®šã—ã¦ãã ã•ã„ã€‚";
                });
            });
        }


        // --- 4. è­°è«–ã‚¿ã‚¤ãƒãƒ¼å‡¦ç† ---
        function startDiscussion(endTime) {
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('night-phase').classList.add('hidden');
            document.getElementById('discussion-phase').classList.remove('hidden');

            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = Date.now();
                const remain = Math.max(0, Math.ceil((endTime - now) / 1000));
                
                // åˆ†:ç§’ è¡¨è¨˜ã«ã™ã‚‹
                const m = Math.floor(remain / 60).toString().padStart(2, '0');
                const s = (remain % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').textContent = `${m}:${s}`;

                // 0ç§’ã«ãªã£ãŸã‚‰
                if (remain <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timer-display').style.color = "red";
                    document.getElementById('timer-display').textContent = "æŠ•ç¥¨ã¸ç§»å‹•ï¼";
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æŠ•ç¥¨ç”»é¢ã¸ï¼ˆæ¬¡å›å®Ÿè£…ï¼‰
                    // setTimeout(() => { window.location.href = 'vote.html...'; }, 2000);
                }
            }, 1000);
        }

    </script>
</body>
</html>
