<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚²ãƒ¼ãƒ ä¸­</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #222; color: white; }
        
        /* ã‚«ãƒ¼ãƒ‰ãƒ»å…±é€š */
        .card { background: #444; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 400px; border: 2px solid #666; }
        .role-text { font-size: 2.5em; font-weight: bold; color: #ff5252; }
        .area-box { background: #333; padding: 15px; margin-top: 20px; border-radius: 8px; border: 1px solid #ff9800; }
        .hidden { display: none !important; }

        /* ãƒœã‚¿ãƒ³ */
        button { font-size: 16px; padding: 10px 20px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
        button:disabled { background: #777; cursor: not-allowed; }
        button.target-btn { background: #2196F3; display: block; width: 80%; margin: 5px auto; }
        button.finish-btn { background: #E91E63; font-weight: bold; width: 100%; font-size: 1.2em; margin-top: 15px; }

        /* ã‚¿ã‚¤ãƒãƒ¼ */
        #timer-display { font-size: 4em; font-weight: bold; color: #00e676; margin: 10px 0; }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        #chat-area { margin-top: 20px; background: #eee; color: #333; padding: 10px; border-radius: 8px; text-align: left; }
        #chat-history { height: 200px; overflow-y: scroll; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
        .chat-msg { margin-bottom: 4px; border-bottom: 1px dotted #ccc; font-size: 14px; }
        .chat-name { font-weight: bold; color: #444; }
        
        /* å…¥åŠ›æ¬„ã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
        .chat-input-row { display: flex; gap: 5px; }
        #chat-input { flex: 1; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
        #chat-send { width: 70px; margin: 0; }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="night-phase">
            <h2>ğŸŒ™ å¤œã®ã‚¿ãƒ¼ãƒ³</h2>
            <div class="card">
                <p style="margin:0;">ã‚ãªãŸã®å½¹è·</p>
                <div id="my-role-display" class="role-text">???</div>
            </div>

            <div id="action-area" class="area-box hidden">
                <h3 id="action-title">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                <p id="action-desc"></p>
                <div id="action-buttons"></div>
            </div>

            <div id="wait-area" class="area-box">
                <p id="wait-msg">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒçµ‚ã‚ã£ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
                <button id="finish-btn" class="finish-btn">ç¢ºèªãƒ»è¡Œå‹•å®Œäº†</button>
            </div>
        </div>

        <div id="discussion-phase" class="hidden">
            <h2>â˜€ï¸ è­°è«–ã‚¿ã‚¤ãƒ </h2>
            <div id="timer-display">00:00</div>
            
            <div id="chat-area">
                <div id="chat-history"></div>
                <div class="chat-input-row">
                    <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸...">
                    <button id="chat-send">é€ä¿¡</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, get, update, onValue, push, onChildAdded, ROOM_ID } from './config.js';

        const params = new URLSearchParams(window.location.search);
        const myName = params.get('name');
        
        let myData = null;
        let hasActed = false;
        let timerInterval = null;

        // --- 1. ç›£è¦–ã¨ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ç›£è¦–
        onValue(ref(db, `rooms/${ROOM_ID}/players/${myName}`), (snap) => {
            myData = snap.val();
            if (!myData) return;
            
            document.getElementById('my-role-display').textContent = myData.original_role;
            
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³UIåˆ¶å¾¡
            if (!myData.actDone && !hasActed) {
                checkRoleAction(myData.original_role);
            }
            if (myData.actDone) {
                document.getElementById('finish-btn').disabled = true;
                document.getElementById('finish-btn').textContent = "ä»–ã®äººã‚’å¾…ã£ã¦ã„ã¾ã™...";
                document.getElementById('action-area').classList.add('hidden');
            }
        });

        // â˜…éƒ¨å±‹å…¨ä½“ã®ç›£è¦– (ãƒ•ã‚§ãƒ¼ã‚ºç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯)
        onValue(ref(db, `rooms/${ROOM_ID}`), (snap) => {
            const roomData = snap.val();
            if (!roomData) return;

            // â–  å¤œãƒ•ã‚§ãƒ¼ã‚ºã®å‡¦ç†
            if (!roomData.phase || roomData.phase === 'night') {
                const players = roomData.players || {};
                const playerList = Object.values(players);
                const total = playerList.length;
                const doneCount = playerList.filter(p => p.actDone).length;
                
                // å…¨å“¡å®Œäº†ãƒã‚§ãƒƒã‚¯ -> è­°è«–ã¸
                if (doneCount === total && total > 0 && !roomData.endTime) {
                    const gameTime = roomData.gameTime || 180;
                    const endTime = Date.now() + (gameTime * 1000);
                    
                    update(ref(db, `rooms/${ROOM_ID}`), {
                        phase: "discussion",
                        endTime: endTime
                    });
                }
            }

            // â–  è­°è«–ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®åˆ‡ã‚Šæ›¿ãˆ
            if (roomData.phase === 'discussion' && roomData.endTime) {
                startDiscussion(roomData.endTime);
            }

            // â˜…è¿½åŠ : æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®ç§»å‹•
            if (roomData.phase === 'voting') {
                window.location.href = `vote.html?name=${encodeURIComponent(myName)}`;
            }
        });

        // --- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ---
        onChildAdded(ref(db, `rooms/${ROOM_ID}/chat`), (snap) => {
            const msg = snap.val();
            const div = document.createElement('div');
            div.className = "chat-msg";
            div.innerHTML = `<span class="chat-name">${msg.name}:</span> ${msg.text}`;
            const history = document.getElementById('chat-history');
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        });

        document.getElementById('chat-send').addEventListener('click', sendChat);
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            push(ref(db, `rooms/${ROOM_ID}/chat`), {
                name: myName,
                text: text,
                timestamp: Date.now()
            });
            input.value = "";
            input.focus(); 
        }


        // --- 2. ãƒœã‚¿ãƒ³å‡¦ç† ---
        document.getElementById('finish-btn').addEventListener('click', () => {
            update(ref(db, `rooms/${ROOM_ID}/players/${myName}`), { actDone: true });
        });

        // --- 3. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
        function checkRoleAction(role) {
            const area = document.getElementById('action-area');
            const btns = document.getElementById('action-buttons');
            const title = document.getElementById('action-title');
            const desc = document.getElementById('action-desc');

            if (!area.classList.contains('hidden')) return;

            if (role === 'å ã„å¸«') {
                area.classList.remove('hidden');
                title.textContent = "ğŸ”® å ã„";
                desc.textContent = "å¯¾è±¡ã‚’é¸æŠ";
                const centerBtn = document.createElement('button');
                centerBtn.textContent = "ğŸ´ ä¸­å¤®ã‚’è¦‹ã‚‹";
                centerBtn.onclick = () => actionSeerCenter();
                btns.appendChild(centerBtn);
                createPlayerButtons("å ã†", actionSeerPlayer);

            } else if (role === 'æ€ªç›—') {
                area.classList.remove('hidden');
                title.textContent = "ğŸ± æ€ªç›—";
                desc.textContent = "ç›—ã‚€å¯¾è±¡ã‚’é¸æŠ";
                createPlayerButtons("ç›—ã‚€", actionThief);
            
            } else if (role === 'äººç‹¼') {
                area.classList.remove('hidden');
                title.textContent = "ğŸº ä»²é–“";
                showWerewolves();
            }
        }

        function createPlayerButtons(label, callback) {
            const btns = document.getElementById('action-buttons');
            get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
                const players = snap.val();
                Object.keys(players).forEach(pName => {
                    if (pName === myName) return;
                    const btn = document.createElement('button');
                    btn.className = "target-btn";
                    btn.textContent = `${pName} (${label})`;
                    btn.onclick = () => callback(pName);
                    btns.appendChild(btn);
                });
            });
        }

        function showWerewolves() {
            get(ref(db, `rooms/${ROOM_ID}/players`)).then((snap) => {
                const players = snap.val();
                let partners = [];
                Object.keys(players).forEach(pName => {
                    if (pName !== myName && players[pName].original_role === 'äººç‹¼') {
                        partners.push(pName);
                    }
                });
                document.getElementById('action-desc').innerText = 
                    partners.length > 0 ? `ä»²é–“: ${partners.join(', ')}` : "ä»²é–“ã¯ã„ã¾ã›ã‚“";
            });
        }

        function actionSeerCenter() {
            if(!confirm("ä¸­å¤®ã‚’è¦‹ã¾ã™ã‹ï¼Ÿ")) return;
            get(ref(db, `rooms/${ROOM_ID}/centerCards`)).then((snap) => {
                const c = snap.val();
                alert(`ä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰: [${c[0]}] [${c[1]}]`);
                finishAction();
            });
        }

        function actionSeerPlayer(target) {
            if(!confirm(`${target}ã•ã‚“ã‚’å ã„ã¾ã™ã‹ï¼Ÿ`)) return;
            get(ref(db, `rooms/${ROOM_ID}/players/${target}/original_role`)).then((snap) => {
                alert(`${target}ã•ã‚“ã¯ã€Œ${snap.val()}ã€ã§ã—ãŸ`);
                finishAction();
            });
        }

        function actionThief(target) {
            if(!confirm(`${target}ã•ã‚“ã‹ã‚‰ç›—ã¿ã¾ã™ã‹ï¼Ÿ`)) return;
            get(ref(db, `rooms/${ROOM_ID}/players/${target}`)).then((snap) => {
                const tData = snap.val();
                const updates = {};
                updates[`players/${myName}/role`] = `æ€ªç›—(å…ƒ${tData.original_role})`;
                updates[`players/${myName}/team`] = tData.team;
                updates[`players/${target}/role`] = `${tData.original_role}(ç›—ã¾ã‚ŒãŸ)`;
                updates[`players/${target}/team`] = 0;

                update(ref(db, `rooms/${ROOM_ID}`), updates).then(() => {
                    alert(`ã‚ãªãŸã¯ã€Œ${tData.original_role}ã€ã«ãªã‚Šã¾ã—ãŸ`);
                    finishAction();
                });
            });
        }

        function finishAction() {
            hasActed = true;
            document.getElementById('action-buttons').innerHTML = "";
            document.getElementById('action-desc').textContent = "å®Œäº†ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        }

        // --- 4. è­°è«–ã‚¿ã‚¤ãƒãƒ¼ (ä¿®æ­£ç‰ˆ) ---
        function startDiscussion(endTime) {
            document.getElementById('night-phase').classList.add('hidden');
            document.getElementById('discussion-phase').classList.remove('hidden');

            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = Date.now();
                const remain = Math.max(0, Math.ceil((endTime - now) / 1000));
                
                const m = Math.floor(remain / 60).toString().padStart(2, '0');
                const s = (remain % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').textContent = `${m}:${s}`;

                // â˜…0ç§’ã«ãªã£ãŸã‚‰æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚ºã¸ç§»è¡Œ
                if (remain <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timer-display').style.color = "red";
                    document.getElementById('timer-display').textContent = "æŠ•ç¥¨ã¸ç§»å‹•ä¸­...";
                    
                    // ã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ã‚’æ›´æ–° (èª°ã‹1äººãŒå®Ÿè¡Œã™ã‚Œã°OK)
                    update(ref(db, `rooms/${ROOM_ID}`), { phase: "voting" });
                }
            }, 1000);
        }
    </script>
</body>
</html>
