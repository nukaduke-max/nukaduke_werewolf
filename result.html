<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµæœç™ºè¡¨</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #222; color: white; }
        
        #winner-banner { 
            font-size: 2em; font-weight: bold; padding: 20px; 
            margin: 20px 0; border: 4px solid white; border-radius: 10px;
            background: #444; color: white;
        }
        .win-villager { background-color: #4CAF50 !important; border-color: #81C784 !important; }
        .win-werewolf { background-color: #F44336 !important; border-color: #E57373 !important; }
        .win-tanner { background-color: #FF9800 !important; border-color: #FFB74D !important; }

        ul { list-style: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid #444; }
        .executed { text-decoration: line-through; color: #888; }
        .executed::after { content: " ğŸ’€å‡¦åˆ‘"; color: red; font-weight: bold; text-decoration: none; }
        .team-0 { color: #81C784; } .team-1 { color: #E57373; } .team-2 { color: #FFB74D; }

        #back-btn { 
            background: #2196F3; color: white; border: none; 
            padding: 15px 30px; font-size: 18px; border-radius: 50px; 
            margin-top: 30px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #wait-status { color: #aaa; font-size: 0.8em; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>ğŸ† çµæœç™ºè¡¨</h1>
    <div id="winner-banner">é›†è¨ˆä¸­...</div>
    <p id="execution-msg"></p>

    <h3>ğŸ­ æ­£ä½“ã¨çµæœ</h3>
    <ul id="player-result-list"></ul>

    <h3>ğŸ—³ æŠ•ç¥¨ã®å†…è¨³</h3>
    <ul id="vote-detail-list"></ul>

    <button id="back-btn">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
    <p id="wait-status">ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ç¢ºèªå¾…ã¡...</p>

    <script type="module">
        import { db, ref, get, update, onValue, ROOM_ID } from './config.js';

        const params = new URLSearchParams(window.location.search);
        const myName = params.get('name');

        // 1. ã€Œè¦‹ã¾ã—ãŸã€ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
        update(ref(db, `rooms/${ROOM_ID}/players/${myName}`), { seenResult: true });

        // 2. çµæœè¨ˆç®—ã¨è¡¨ç¤º (getã§ä¸€åº¦ã ã‘å–å¾—)
        get(ref(db, `rooms/${ROOM_ID}`)).then((snap) => {
            const data = snap.val();
            if (data) calculateResult(data);
        });

        // 3. å…¨å“¡ã®é–²è¦§çŠ¶æ³ç›£è¦–ï¼†ãƒªã‚»ãƒƒãƒˆ
        onValue(ref(db, `rooms/${ROOM_ID}/players`), (snap) => {
            const players = snap.val() || {};
            const playerList = Object.values(players);
            const total = playerList.length;
            const seenCount = playerList.filter(p => p.seenResult).length;

            document.getElementById('wait-status').textContent = 
                `çµæœç¢ºèªæ¸ˆã¿: ${seenCount} / ${total} äºº`;

            // â˜…å…¨å“¡è¦‹çµ‚ã‚ã£ãŸã‚‰ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ¬¡ã®æº–å‚™ã‚’ã™ã‚‹
            if (total > 0 && seenCount === total) {
                const updates = {};
                updates[`status`] = "waiting";     // ãƒ­ãƒ“ãƒ¼å¾…æ©ŸçŠ¶æ…‹ã«æˆ»ã™
                updates[`phase`] = null;
                updates[`endTime`] = null;
                updates[`votes`] = null;
                updates[`gameTime`] = null;
                
                Object.keys(players).forEach(pName => {
                    updates[`players/${pName}/role`] = "undecided";
                    updates[`players/${pName}/original_role`] = null;
                    updates[`players/${pName}/team`] = null;
                    updates[`players/${pName}/actDone`] = null;
                    updates[`players/${pName}/seenResult`] = null;
                });

                update(ref(db, `rooms/${ROOM_ID}`), updates);
            }
        });

        // ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ (ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆã•ãšã«è‡ªåˆ†ã ã‘ç§»å‹•)
        document.getElementById('back-btn').addEventListener('click', () => {
            window.location.href = `index.html?name=${encodeURIComponent(myName)}&auto=true`;
        });

        // --- çµæœè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
        function calculateResult(data) {
            const players = data.players || {};
            const votes = data.votes || {};
            const playerList = Object.keys(players);
            const voteCounts = {};
            playerList.forEach(p => voteCounts[p] = 0);
            voteCounts["NO_EXECUTION"] = 0;
            const voteDetails = [];
            
            Object.keys(votes).forEach(voter => {
                const target = votes[voter];
                if (target === "NO_EXECUTION") {
                    voteCounts["NO_EXECUTION"]++;
                    voteDetails.push(`${voter} â” (å¹³å’Œæ‘)`);
                } else {
                    if (voteCounts[target] !== undefined) voteCounts[target]++;
                    voteDetails.push(`${voter} â” ${target}`);
                }
            });

            let maxVotes = 0;
            Object.keys(voteCounts).forEach(key => {
                if (key !== "NO_EXECUTION" && voteCounts[key] > maxVotes) maxVotes = voteCounts[key];
            });

            let executedPlayers = [];
            if (maxVotes > 1) {
                executedPlayers = playerList.filter(p => voteCounts[p] === maxVotes);
            }

            let winnerTeam = ""; 
            let winMsg = "";
            const tannerExecuted = executedPlayers.some(p => players[p].team === 2);
            if (tannerExecuted) {
                winnerTeam = "tanner";
                winMsg = "ğŸ‘» åŠã‚Šäººã®å‹åˆ©ï¼";
            } else {
                const werewolfExecuted = executedPlayers.some(p => players[p].team === 1);
                const werewolfExists = playerList.some(p => players[p].team === 1);

                if (werewolfExecuted) {
                    winnerTeam = "villager";
                    winMsg = "ğŸ‰ æ‘äººå´ã®å‹åˆ©ï¼(äººç‹¼å‡¦åˆ‘)";
                } else {
                    if (executedPlayers.length === 0) {
                        if (!werewolfExists) {
                            winnerTeam = "villager";
                            winMsg = "ğŸ‰ æ‘äººå´ã®å‹åˆ©ï¼(å¹³å’Œæ‘)";
                        } else {
                            winnerTeam = "werewolf";
                            winMsg = "ğŸº äººç‹¼å´ã®å‹åˆ©...(å‡¦åˆ‘ãªã—)";
                        }
                    } else {
                        if (!werewolfExists) {
                            winnerTeam = "werewolf";
                            winMsg = "ğŸ’€ æ•—åŒ—...(æ‘äººã‚’å‡¦åˆ‘)";
                        } else {
                            winnerTeam = "werewolf";
                            winMsg = "ğŸº äººç‹¼å´ã®å‹åˆ©ï¼";
                        }
                    }
                }
            }
            displayScreen(winnerTeam, winMsg, executedPlayers, players, voteDetails);
        }

        function displayScreen(team, msg, executed, players, voteDetails) {
            const banner = document.getElementById('winner-banner');
            banner.textContent = msg;
            if (team === "villager") banner.className = "win-villager";
            if (team === "werewolf") banner.className = "win-werewolf";
            if (team === "tanner") banner.className = "win-tanner";

            const execMsg = document.getElementById('execution-msg');
            if (executed.length > 0) execMsg.innerHTML = `å‡¦åˆ‘: <b>${executed.join(", ")}</b>`;
            else execMsg.textContent = "å‡¦åˆ‘ãªã—";

            const pList = document.getElementById('player-result-list');
            Object.keys(players).forEach(name => {
                const p = players[name];
                const li = document.createElement('li');
                let html = `<span style="font-size:1.1em;">${name}</span>: `;
                html += `<span class="team-${p.team}">${p.role}</span>`;
                if (executed.includes(name)) li.className = "executed";
                li.innerHTML = html;
                pList.appendChild(li);
            });

            const vList = document.getElementById('vote-detail-list');
            voteDetails.forEach(d => {
                const li = document.createElement('li');
                li.textContent = d;
                vList.appendChild(li);
            });
        }
    </script>
</body>
</html>
