<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµæœç™ºè¡¨</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #222; color: white; }
        
        /* å‹è€…è¡¨ç¤º */
        #winner-banner { 
            font-size: 2em; font-weight: bold; padding: 20px; 
            margin: 20px 0; border: 4px solid white; border-radius: 10px;
            background: #444; color: white;
        }
        .win-villager { background-color: #4CAF50 !important; color: white; border-color: #81C784 !important; }
        .win-werewolf { background-color: #F44336 !important; color: white; border-color: #E57373 !important; }
        .win-tanner { background-color: #FF9800 !important; color: white; border-color: #FFB74D !important; }

        /* ãƒªã‚¹ãƒˆ */
        .section-title { margin-top: 30px; border-bottom: 1px solid #555; padding-bottom: 5px; color: #aaa; }
        ul { list-style: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid #444; }
        
        .role-reveal { font-weight: bold; font-size: 1.2em; }
        .team-0 { color: #81C784; } /* æ‘äºº */
        .team-1 { color: #E57373; } /* äººç‹¼ */
        .team-2 { color: #FFB74D; } /* åŠã‚Šäºº */
        
        .executed { text-decoration: line-through; color: #888; }
        .executed::after { content: " ğŸ’€å‡¦åˆ‘"; color: red; font-weight: bold; text-decoration: none; }

        /* æ¬¡ã¸ãƒœã‚¿ãƒ³ */
        #reset-btn { 
            background: #2196F3; color: white; border: none; 
            padding: 15px 30px; font-size: 18px; border-radius: 50px; 
            margin-top: 30px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <h1>ğŸ† çµæœç™ºè¡¨</h1>

    <div id="winner-banner">é›†è¨ˆä¸­...</div>
    <p id="execution-msg"></p>

    <h3 class="section-title">ğŸ­ æ­£ä½“ã¨çµæœ</h3>
    <ul id="player-result-list"></ul>

    <h3 class="section-title">ğŸ—³ æŠ•ç¥¨ã®å†…è¨³</h3>
    <ul id="vote-detail-list"></ul>

    <button id="reset-btn">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>

    <script type="module">
        import { db, ref, get, update, remove, ROOM_ID } from './config.js';

        // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã‚‰ä¸€åº¦ã ã‘è¨ˆç®—ãƒ»è¡¨ç¤ºã™ã‚‹
        get(ref(db, `rooms/${ROOM_ID}`)).then((snap) => {
            const data = snap.val();
            if (data) {
                calculateResult(data);
            }
        });

        function calculateResult(data) {
            const players = data.players || {};
            const votes = data.votes || {};
            const playerList = Object.keys(players);

            // 1. ç¥¨ã‚’é›†è¨ˆã™ã‚‹
            const voteCounts = {};
            playerList.forEach(p => voteCounts[p] = 0);
            voteCounts["NO_EXECUTION"] = 0; // å¹³å’Œæ‘æŠ•ç¥¨ç”¨

            // èª°ãŒèª°ã«å…¥ã‚ŒãŸã‹ã®ãƒªã‚¹ãƒˆä½œæˆ
            const voteDetails = [];
            Object.keys(votes).forEach(voter => {
                const target = votes[voter];
                if (target === "NO_EXECUTION") {
                    voteCounts["NO_EXECUTION"]++;
                    voteDetails.push(`${voter} â” (æŠ•ç¥¨ãªã—)`);
                } else {
                    if (voteCounts[target] !== undefined) voteCounts[target]++;
                    voteDetails.push(`${voter} â” ${target}`);
                }
            });

            // 2. å‡¦åˆ‘è€…ã‚’æ±ºå®šã™ã‚‹
            // ãƒ«ãƒ¼ãƒ«: æœ€å¤šå¾—ç¥¨è€…ãŒå‡¦åˆ‘ã€‚ãŸã ã—æœ€å¤šç¥¨ãŒ1ç¥¨ä»¥ä¸‹ã®å ´åˆã¯ã€Œå‡¦åˆ‘ãªã—ã€
            let maxVotes = 0;
            Object.keys(voteCounts).forEach(key => {
                if (key !== "NO_EXECUTION" && voteCounts[key] > maxVotes) {
                    maxVotes = voteCounts[key];
                }
            });

            let executedPlayers = [];
            if (maxVotes > 1) {
                executedPlayers = playerList.filter(p => voteCounts[p] === maxVotes);
            }

            // 3. å‹åˆ©åˆ¤å®š
            // teamID: 0=æ‘äºº, 1=äººç‹¼, 2=åŠã‚Šäºº
            let winnerTeam = ""; // "villager", "werewolf", "tanner"
            let winMsg = "";

            // A. åŠã‚Šäººãƒã‚§ãƒƒã‚¯
            const tannerExecuted = executedPlayers.some(p => players[p].team === 2);
            if (tannerExecuted) {
                winnerTeam = "tanner";
                winMsg = "ğŸ‘» åŠã‚Šäººã®å‹åˆ©ï¼";
            } else {
                // B. äººç‹¼å‡¦åˆ‘ãƒã‚§ãƒƒã‚¯
                const werewolfExecuted = executedPlayers.some(p => players[p].team === 1);
                
                // å ´ã«äººç‹¼ãŒã„ã‚‹ã‹ï¼Ÿ
                const werewolfExists = playerList.some(p => players[p].team === 1);

                if (werewolfExecuted) {
                    winnerTeam = "villager";
                    winMsg = "ğŸ‰ æ‘äººãƒãƒ¼ãƒ ã®å‹åˆ©ï¼ (äººç‹¼ã‚’å‡¦åˆ‘ã—ã¾ã—ãŸ)";
                } else {
                    if (executedPlayers.length === 0) {
                        // èª°ã‚‚å‡¦åˆ‘ã•ã‚Œãªã‹ã£ãŸå ´åˆ
                        if (!werewolfExists) {
                            winnerTeam = "villager";
                            winMsg = "ğŸ‰ æ‘äººãƒãƒ¼ãƒ ã®å‹åˆ©ï¼ (å¹³å’Œæ‘æˆåŠŸ)";
                        } else {
                            winnerTeam = "werewolf";
                            winMsg = "ğŸº äººç‹¼ãƒãƒ¼ãƒ ã®å‹åˆ©... (èª°ã‚‚å‡¦åˆ‘ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ)";
                        }
                    } else {
                        // èª°ã‹å‡¦åˆ‘ã•ã‚ŒãŸãŒã€ãã‚Œã¯äººç‹¼ã§ã¯ãªã‹ã£ãŸ
                        if (!werewolfExists) {
                            winnerTeam = "werewolf"; // æ‘äººã—ã‹ã„ãªã„ã®ã«æ‘äººã‚’åŠã£ãŸï¼æ•—åŒ—æ‰±ã„
                            winMsg = "ğŸ’€ æ•—åŒ—... (å¹³å’Œæ‘ãªã®ã«å‡¦åˆ‘ã—ã¦ã—ã¾ã„ã¾ã—ãŸ)";
                        } else {
                            winnerTeam = "werewolf";
                            winMsg = "ğŸº äººç‹¼ãƒãƒ¼ãƒ ã®å‹åˆ©ï¼";
                        }
                    }
                }
            }

            displayScreen(winnerTeam, winMsg, executedPlayers, players, voteDetails);
        }

        function displayScreen(team, msg, executed, players, voteDetails) {
            // ãƒãƒŠãƒ¼è¡¨ç¤º
            const banner = document.getElementById('winner-banner');
            banner.textContent = msg;
            if (team === "villager") banner.className = "win-villager";
            if (team === "werewolf") banner.className = "win-werewolf";
            if (team === "tanner") banner.className = "win-tanner";

            // å‡¦åˆ‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const execMsg = document.getElementById('execution-msg');
            if (executed.length > 0) {
                execMsg.innerHTML = `å‡¦åˆ‘ã•ã‚ŒãŸã®ã¯ <b>${executed.join("ã•ã‚“, ")}ã•ã‚“</b> ã§ã—ãŸã€‚`;
            } else {
                execMsg.textContent = "å‡¦åˆ‘ã•ã‚ŒãŸäººã¯ã„ã¾ã›ã‚“ã§ã—ãŸã€‚";
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆè¡¨ç¤º
            const pList = document.getElementById('player-result-list');
            Object.keys(players).forEach(name => {
                const p = players[name];
                const li = document.createElement('li');
                
                // åå‰ã¨å½¹è·
                let html = `<span style="font-size:1.1em;">${name}</span>: `;
                html += `<span class="role-reveal team-${p.team}">${p.role}</span>`;
                
                // å‡¦åˆ‘ãƒãƒ¼ã‚¯
                if (executed.includes(name)) {
                    li.className = "executed";
                }
                
                li.innerHTML = html;
                pList.appendChild(li);
            });

            // æŠ•ç¥¨è©³ç´°
            const vList = document.getElementById('vote-detail-list');
            voteDetails.forEach(detail => {
                const li = document.createElement('li');
                li.textContent = detail;
                vList.appendChild(li);
            });
        }

        // --- æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸ï¼ˆãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹ï¼‰ ---
        document.getElementById('reset-btn').addEventListener('click', () => {
            if(!confirm("ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) return;

            // éƒ¨å±‹ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã™ã‚‹
            const updates = {};
            updates[`phase`] = null; // ãƒ•ã‚§ãƒ¼ã‚ºãƒªã‚»ãƒƒãƒˆ
            updates[`endTime`] = null;
            updates[`votes`] = null; // æŠ•ç¥¨ãƒªã‚»ãƒƒãƒˆ
            updates[`gameTime`] = null;
            updates[`status`] = "waiting"; // ãƒ­ãƒ“ãƒ¼å¾…æ©ŸçŠ¶æ…‹ã¸

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
            // â€»å…¨å“¡åˆ†ã‚„ã‚‹ã®ã¯å¤§å¤‰ãªã®ã§ã€ã¨ã‚Šã‚ãˆãšéƒ¨å±‹ã®statusã‚’å¤‰ãˆã¦ã€
            // å„è‡ªãŒãƒ­ãƒ“ãƒ¼ã«æˆ»ã£ãŸæ™‚ã«ä¸Šæ›¸ãã•ã‚Œã‚‹ä»•çµ„ã¿ã«ä»»ã›ã‚‹ã‹ã€ã“ã“ã§æ¶ˆã™ã‹ã€‚
            // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€ŒæŠ•ç¥¨ã¨ãƒ•ã‚§ãƒ¼ã‚ºã€ã ã‘æ¶ˆã—ã¦ã€index.htmlã«æˆ»ã—ã¾ã™ã€‚

            update(ref(db, `rooms/${ROOM_ID}`), updates).then(() => {
                window.location.href = "index.html";
            });
        });
        
        // ä»–ã®äººãŒãƒªã‚»ãƒƒãƒˆã—ãŸå ´åˆã‚‚è‡ªå‹•ã§æˆ»ã‚‹ã‚ˆã†ã«ã™ã‚‹
        import { onValue } from './config.js';
        onValue(ref(db, `rooms/${ROOM_ID}/status`), (snap) => {
            if (snap.val() === "waiting") {
                window.location.href = "index.html";
            }
        });

    </script>
</body>
</html>
