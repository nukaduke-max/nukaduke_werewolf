<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµæœç™ºè¡¨</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #222; color: white; transition: background-color 1s ease; }
        
        /* å‹è€…ãƒãƒŠãƒ¼ï¼ˆã‚ˆã‚Šæ´¾æ‰‹ã«ï¼‰ */
        #winner-banner { 
            font-size: 2.5em; font-weight: bold; padding: 30px 10px; 
            margin: 20px 0; border: 5px solid white; border-radius: 15px;
            background: rgba(0,0,0,0.5); color: white;
            text-shadow: 2px 2px 4px #000;
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
        }

        /* ãƒãƒ¼ãƒ ã”ã¨ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼ˆbodyã«é©ç”¨ï¼‰ */
        .bg-villager { background-color: #2E7D32 !important; } /* æ‘äººå‹åˆ©ï¼šç·‘ */
        .bg-werewolf { background-color: #C62828 !important; } /* äººç‹¼å‹åˆ©ï¼šèµ¤ */
        .bg-tanner { background-color: #F57C00 !important; }   /* åŠã‚Šäººå‹åˆ©ï¼šã‚ªãƒ¬ãƒ³ã‚¸ */

        ul { list-style: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.3); }
        
        .executed { text-decoration: line-through; opacity: 0.7; }
        .executed::after { content: " ğŸ’€å‡¦åˆ‘"; color: #ffeb3b; font-weight: bold; text-decoration: none; font-size: 1.2em;}
        
        .team-0 { color: #A5D6A7; font-weight:bold; } /* æ‘äººæ–‡å­—è‰² */
        .team-1 { color: #EF9A9A; font-weight:bold; } /* äººç‹¼æ–‡å­—è‰² */
        .team-2 { color: #FFCC80; font-weight:bold; } /* åŠã‚Šäººæ–‡å­—è‰² */

        #back-btn { 
            background: #fff; color: #333; border: none; font-weight: bold;
            padding: 15px 40px; font-size: 18px; border-radius: 50px; 
            margin-top: 40px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #wait-status { font-size: 0.9em; margin-top: 10px; opacity: 0.8; }
    </style>
</head>
<body>

    <h1>ğŸ† çµæœç™ºè¡¨</h1>
    <div id="winner-banner">é›†è¨ˆä¸­...</div>
    
    <h3 style="margin-top:30px;">ğŸ’€ å‡¦åˆ‘ã•ã‚ŒãŸäºº</h3>
    <p id="execution-msg" style="font-size:1.2em; font-weight:bold;">-</p>

    <h3>ğŸ­ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ­£ä½“</h3>
    <ul id="player-result-list"></ul>

    <h3>ğŸ—³ æŠ•ç¥¨ã®å†…è¨³</h3>
    <ul id="vote-detail-list"></ul>

    <button id="back-btn">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
    <p id="wait-status">ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ç¢ºèªå¾…ã¡...</p>

    <script type="module">
        import { db, ref, get, update, onValue, ROOM_ID } from './config.js';

        const params = new URLSearchParams(window.location.search);
        const myName = params.get('name');

        // 1. é–²è¦§æ¸ˆã¿ãƒ•ãƒ©ã‚°
        update(ref(db, `rooms/${ROOM_ID}/players/${myName}`), { seenResult: true });

        // 2. çµæœè¨ˆç®— (getã§å–å¾—)
        get(ref(db, `rooms/${ROOM_ID}`)).then((snap) => {
            const data = snap.val();
            if (data) calculateResult(data);
        });

        // 3. å…¨å“¡ç¢ºèªã—ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
        onValue(ref(db, `rooms/${ROOM_ID}/players`), (snap) => {
            const players = snap.val() || {};
            const playerList = Object.values(players);
            const total = playerList.length;
            const seenCount = playerList.filter(p => p.seenResult).length;

            document.getElementById('wait-status').textContent = 
                `çµæœç¢ºèªæ¸ˆã¿: ${seenCount} / ${total} äºº`;

            if (total > 0 && seenCount === total) {
                const updates = {};
                updates[`status`] = "waiting";     
                updates[`phase`] = null;
                updates[`endTime`] = null;
                updates[`votes`] = null;
                updates[`gameTime`] = null;
                
                Object.keys(players).forEach(pName => {
                    updates[`players/${pName}/role`] = "undecided";
                    updates[`players/${pName}/original_role`] = null;
                    updates[`players/${pName}/team`] = null;
                    updates[`players/${pName}/actDone`] = null;
                    updates[`players/${pName}/seenResult`] = null;
                });
                update(ref(db, `rooms/${ROOM_ID}`), updates);
            }
        });

        document.getElementById('back-btn').addEventListener('click', () => {
            window.location.href = `index.html?name=${encodeURIComponent(myName)}&auto=true`;
        });

        // --- å‹æ•—åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (ã”è¦æœ›é€šã‚Šã«ä¿®æ­£) ---
        function calculateResult(data) {
            const players = data.players || {};
            const votes = data.votes || {};
            const playerList = Object.keys(players);
            
            // --- A. é›†è¨ˆ ---
            const voteCounts = {};
            playerList.forEach(p => voteCounts[p] = 0);
            
            const voteDetails = [];
            Object.keys(votes).forEach(voter => {
                const target = votes[voter];
                if (target !== "NO_EXECUTION") {
                    if (voteCounts[target] !== undefined) voteCounts[target]++;
                    voteDetails.push(`${voter} â” ${target}`);
                } else {
                    voteDetails.push(`${voter} â” (å¹³å’Œæ‘å¸Œæœ›)`);
                }
            });

            // --- B. å‡¦åˆ‘è€…æ±ºå®š (åŒæ•°ãªã‚‰å…¨å“¡å‡¦åˆ‘) ---
            let maxVotes = 0;
            // ã¾ãšæœ€å¤§å¾—ç¥¨æ•°ã‚’æ¢ã™
            Object.keys(voteCounts).forEach(key => {
                if (voteCounts[key] > maxVotes) maxVotes = voteCounts[key];
            });

            let executedPlayers = [];
            // â˜…ä¿®æ­£: 1ç¥¨ã§ã‚‚ã€ãã‚ŒãŒæœ€å¤šãªã‚‰å‡¦åˆ‘ã™ã‚‹ (0ç¥¨ã¯é™¤å¤–)
            if (maxVotes > 0) {
                executedPlayers = playerList.filter(p => voteCounts[p] === maxVotes);
            }

            // --- C. å‹åˆ©åˆ¤å®š (å„ªå…ˆé †ä½é †) ---
            // team: 0=æ‘äºº, 1=äººç‹¼, 2=åŠã‚Šäºº
            
            let winnerTeam = ""; 
            let winMsg = "";

            // 1. åŠã‚ŠäººãŒåŠã‚‰ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
            const tannerExecuted = executedPlayers.some(p => players[p].team === 2);
            // 2. äººç‹¼ãŒåŠã‚‰ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
            const werewolfExecuted = executedPlayers.some(p => players[p].team === 1);
            // 3. å ´ã«äººç‹¼ãŒã„ã‚‹ã‹ï¼Ÿ (ç”Ÿå­˜ã—ã¦ã„ã‚‹ã‹ã§ã¯ãªãã€ãƒ¡ãƒ³ãƒãƒ¼ã«ã„ã‚‹ã‹)
            const werewolfExists = playerList.some(p => players[p].team === 1);

            if (tannerExecuted) {
                // ã€æœ€å„ªå…ˆã€‘åŠã‚Šäººã®å‹ã¡
                winnerTeam = "tanner";
                winMsg = "ğŸ‘» åŠã‚Šäººã®å‹åˆ©ï¼";
            } 
            else if (werewolfExecuted) {
                // ã€æ¬¡ç‚¹ã€‘äººç‹¼ãŒåŠã‚‰ã‚ŒãŸã‚‰æ‘äººã®å‹ã¡
                winnerTeam = "villager";
                winMsg = "ğŸ‰ æ‘äººãƒãƒ¼ãƒ ã®å‹åˆ©ï¼";
            } 
            else if (werewolfExists) {
                // ã€ãã®æ¬¡ã€‘(èª°ã‚‚åŠã‚‰ã‚Œã¦ãªã„ or æ‘äººãŒåŠã‚‰ã‚ŒãŸ) ã‹ã¤ äººç‹¼ãŒã„ã‚‹ãªã‚‰ã€äººç‹¼ã®å‹ã¡
                // â€»åŒç¥¨å…¨å“¡å‡¦åˆ‘ãƒ«ãƒ¼ãƒ«ã®å ´åˆã€äººç‹¼ãŒä¸€äººã§ã‚‚æ­»ã­ã°æ‘äººå‹ã¡ã§ã™ãŒã€
                // ã“ã“ã«æ¥ã¦ã„ã‚‹æ™‚ç‚¹ã§ã€Œäººç‹¼ã¯æ­»ã‚“ã§ã„ãªã„ã€ã®ã§ã€äººç‹¼ã®å‹ã¡ã§ã™ã€‚
                winnerTeam = "werewolf";
                winMsg = "ğŸº äººç‹¼ãƒãƒ¼ãƒ ã®å‹åˆ©ï¼";
            } 
            else {
                // ã€æœ€å¾Œã€‘äººç‹¼ãŒã„ãªã„ (å¹³å’Œæ‘) å ´åˆ
                if (executedPlayers.length === 0) {
                    // å¹³å’Œæ‘æˆåŠŸ (èª°ã‚‚åŠã‚‰ãªã‹ã£ãŸ)
                    winnerTeam = "villager";
                    winMsg = "ğŸ•Šï¸ å¹³å’Œæ‘æˆåŠŸï¼æ‘äººå‹åˆ©";
                } else {
                    // å¹³å’Œæ‘å¤±æ•— (èª°ã‹åŠã£ã¦ã—ã¾ã£ãŸ) -> æ€ªç›—ãªã©ã®äººå¤–(äººç‹¼å´)ã®å‹ã¡æ‰±ã„
                    winnerTeam = "werewolf";
                    winMsg = "ğŸ’€ æ•—åŒ—... (å¹³å’Œæ‘å¤±æ•—)";
                }
            }

            displayScreen(winnerTeam, winMsg, executedPlayers, players, voteDetails);
        }

        function displayScreen(team, msg, executed, players, voteDetails) {
            // èƒŒæ™¯è‰²ã‚’å¤‰ãˆã‚‹
            document.body.className = `bg-${team}`;

            const banner = document.getElementById('winner-banner');
            banner.textContent = msg;

            const execMsg = document.getElementById('execution-msg');
            if (executed.length > 0) {
                execMsg.innerHTML = `${executed.join("ã•ã‚“, ")}ã•ã‚“`;
            } else {
                execMsg.textContent = "ãªã— (å¹³å’Œæ‘æŠ•ç¥¨)";
            }

            const pList = document.getElementById('player-result-list');
            Object.keys(players).forEach(name => {
                const p = players[name];
                const li = document.createElement('li');
                
                let html = `<span style="font-size:1.1em;">${name}</span>: `;
                html += `<span class="team-${p.team}">${p.role}</span>`;
                
                if (executed.includes(name)) {
                    li.className = "executed";
                }
                
                li.innerHTML = html;
                pList.appendChild(li);
            });

            const vList = document.getElementById('vote-detail-list');
            voteDetails.forEach(d => {
                const li = document.createElement('li');
                li.textContent = d;
                vList.appendChild(li);
            });
        }
    </script>
</body>
</html>
