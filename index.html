<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¯ãƒ³ãƒŠã‚¤ãƒˆäººç‹¼ï¼ˆãƒ­ãƒ“ãƒ¼ï¼‰</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, button { font-size: 16px; padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸº ãƒ­ãƒ“ãƒ¼</h1>

        <div id="login-screen">
            <input type="text" id="username" placeholder="åå‰ (ä¾‹: ãƒãƒ)">
            <input type="password" id="password" placeholder="åˆè¨€è‘‰">
            <button id="login-btn">å…¥å®¤</button>
        </div>

        <div id="lobby-screen" class="hidden">
            <p>å‚åŠ è€…: <span id="player-count">0</span>äºº</p>
            <ul id="player-list" style="text-align:left;"></ul>
            <hr>
            <h3>ã‚²ãƒ¼ãƒ è¨­å®š</h3>
            <div>ğŸºäººç‹¼ <input type="number" id="role-werewolf" value="2" style="width:50px;"></div>
            <div>ğŸ”®å ã„ <input type="number" id="role-seer" value="1" style="width:50px;"></div>
            <div>ğŸ±æ€ªç›— <input type="number" id="role-thief" value="1" style="width:50px;"></div>
            <div>ğŸ‘±æ‘äºº <input type="number" id="role-villager" value="0" style="width:50px;"></div>
            <p id="status-msg">æº–å‚™ä¸­...</p>
            
            <button id="start-btn" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</button>
        </div>
    </div>

    <script type="module">
        // â˜…ã•ã£ãä½œã£ãŸconfig.jsã‹ã‚‰æ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€ï¼ˆä¾¿åˆ©ï¼ï¼‰
        import { db, ref, set, update, onValue, remove, onDisconnect, ROOM_ID, PASSWORD } from './config.js';

        let myName = "";
        let currentPlayers = [];

        // ãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('login-btn').addEventListener('click', () => {
            const name = document.getElementById('username').value.trim();
            if (document.getElementById('password').value !== PASSWORD) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
            if (!name) return;

            myName = name;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');

            // å‚åŠ ç™»éŒ²
            const userRef = ref(db, `rooms/${ROOM_ID}/players/${myName}`);
            set(userRef, { status: "online", role: "undecided" });
            //onDisconnect(userRef).remove();

            setupLobby();
        });

        function setupLobby() {
            // 1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç›£è¦–
            onValue(ref(db, `rooms/${ROOM_ID}/players`), (snap) => {
                const data = snap.val() || {};
                currentPlayers = Object.keys(data);
                document.getElementById('player-count').textContent = currentPlayers.length;
                
                const list = document.getElementById('player-list');
                list.innerHTML = currentPlayers.map(p => `<li>${p}</li>`).join('');
                
                checkReady();
            });

            // 2. ã‚²ãƒ¼ãƒ é–‹å§‹ç›£è¦–ï¼ˆâ˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼‰
            // ç®¡ç†è€…ãŒé–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ status ãŒ 'playing' ã«ãªã‚Šã¾ã™ã€‚
            // ã™ã‚‹ã¨ã€å‚åŠ è€…å…¨å“¡ãŒè‡ªå‹•çš„ã« game.html ã«é£›ã°ã•ã‚Œã¾ã™ã€‚
            onValue(ref(db, `rooms/${ROOM_ID}/status`), (snap) => {
                if (snap.val() === 'playing') {
                    // åå‰ã‚’æŒã£ã¦æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸ç§»å‹•
                    window.location.href = `game.html?name=${encodeURIComponent(myName)}`;
                }
            });
        }

        // æº–å‚™OKã‹ãƒã‚§ãƒƒã‚¯
        function checkReady() {
            const w = parseInt(document.getElementById('role-werewolf').value);
            const s = parseInt(document.getElementById('role-seer').value);
            const t = parseInt(document.getElementById('role-thief').value);
            const v = parseInt(document.getElementById('role-villager').value);
            const total = w + s + t + v;
            
            const btn = document.getElementById('start-btn');
            // äººæ•° + 2æšã®ã‚«ãƒ¼ãƒ‰ãŒå¿…è¦
            if (currentPlayers.length > 0 && total === currentPlayers.length + 2) {
                document.getElementById('status-msg').textContent = "æº–å‚™OK!";
                btn.disabled = false;
                btn.style.backgroundColor = "#ff9800";
            } else {
                document.getElementById('status-msg').textContent = `ã‚«ãƒ¼ãƒ‰æšæ•°ãŒåˆã„ã¾ã›ã‚“ (ç¾åœ¨${total}æš / å¿…è¦${currentPlayers.length+2}æš)`;
                btn.disabled = true;
                btn.style.backgroundColor = "#ccc";
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ï¼ˆã“ã“ã§ã™ã”ã„å‡¦ç†ã‚’ã—ã¾ã™ï¼‰
        document.getElementById('start-btn').addEventListener('click', () => {
            // 1. å½¹è·ã‚«ãƒ¼ãƒ‰ã®å±±ã‚’ä½œã‚‹
            let deck = [];
            deck = deck.concat(Array(parseInt(document.getElementById('role-werewolf').value)).fill('äººç‹¼'));
            deck = deck.concat(Array(parseInt(document.getElementById('role-seer').value)).fill('å ã„å¸«'));
            deck = deck.concat(Array(parseInt(document.getElementById('role-thief').value)).fill('æ€ªç›—'));
            deck = deck.concat(Array(parseInt(document.getElementById('role-villager').value)).fill('æ‘äºº'));

            // 2. ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã«æ··ãœã‚‹ï¼‰
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }

            // 3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é…ã‚‹
            const updates = {};
            currentPlayers.forEach((player, index) => {
                updates[`players/${player}/role`] = deck[index];
            });

            // 4. ä½™ã£ãŸ2æšã‚’ã€Œä¸­å¤®ã®ã‚«ãƒ¼ãƒ‰ã€ã¨ã—ã¦ä¿å­˜
            updates[`centerCards`] = [deck[deck.length-2], deck[deck.length-1]];
            
            // 5. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œãƒ—ãƒ¬ã‚¤ä¸­ã€ã«å¤‰æ›´ï¼ˆã“ã‚Œã§å…¨å“¡ã‚¸ãƒ£ãƒ³ãƒ—ï¼ï¼‰
            updates[`status`] = "playing";

            update(ref(db, `rooms/${ROOM_ID}`), updates);
        });
    </script>
</body>
</html>
