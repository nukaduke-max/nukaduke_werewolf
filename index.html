<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ¯ãƒ³ãƒŠã‚¤ãƒˆäººç‹¼ï¼ˆãƒ­ãƒ“ãƒ¼ï¼‰</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, button { font-size: 16px; padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px; }
        .hidden { display: none; }
        .setting-row { margin: 5px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸº ãƒ­ãƒ“ãƒ¼</h1>

        <div id="login-screen">
            <input type="text" id="username" placeholder="åå‰ (ä¾‹: ãƒãƒ)">
            <input type="password" id="password" placeholder="åˆè¨€è‘‰">
            <button id="login-btn">å…¥å®¤</button>
        </div>

        <div id="lobby-screen" class="hidden">
            <p>å‚åŠ è€…: <span id="player-count">0</span>äºº</p>
            <ul id="player-list" style="text-align:left;"></ul>
            <hr>
            <h3>ã‚²ãƒ¼ãƒ è¨­å®š</h3>
            
            <div class="setting-row">
                <label>â± è­°è«–æ™‚é–“ (ç§’)</label>
                <input type="number" id="conf-time" value="180" style="width:80px;">
            </div>

            <hr>
            <div class="setting-row">ğŸºäººç‹¼ <input type="number" id="role-werewolf" value="2" style="width:50px;"></div>
            <div class="setting-row">ğŸ”®å ã„ <input type="number" id="role-seer" value="1" style="width:50px;"></div>
            <div class="setting-row">ğŸ±æ€ªç›— <input type="number" id="role-thief" value="1" style="width:50px;"></div>
            <div class="setting-row">ğŸ‘±æ‘äºº <input type="number" id="role-villager" value="0" style="width:50px;"></div>
            
            <p id="status-msg">æº–å‚™ä¸­...</p>
            
            <button id="start-btn" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</button>
        </div>
    </div>

    <script type="module">
        import { db, ref, set, update, onValue, get, ROOM_ID, PASSWORD } from './config.js';

        let myName = "";
        let currentPlayers = [];

        // â˜…è¿½åŠ : è¨­å®šã‚’å¾©å…ƒã™ã‚‹
        loadSettings();

        // --- 1. è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ or æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³åˆ¤å®š ---
        const params = new URLSearchParams(window.location.search);
        const autoLogin = params.get('auto');
        const urlName = params.get('name');

        if (autoLogin && urlName) {
            myName = urlName;
            document.getElementById('username').value = myName;
            startLobbyLogic();
        }

        document.getElementById('login-btn').addEventListener('click', () => {
            const name = document.getElementById('username').value.trim();
            if (document.getElementById('password').value !== PASSWORD) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
            if (!name) return;

            myName = name;
            // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã‚‚åå‰ã ã‘ä¿å­˜ã—ã¦ãŠãã¨ä¾¿åˆ©
            localStorage.setItem('werewolf_username', myName);
            startLobbyLogic();
        });

        // ä¿å­˜ã•ã‚ŒãŸåå‰ãŒã‚ã‚Œã°å…¥ã‚Œã¦ãŠã
        const savedName = localStorage.getItem('werewolf_username');
        if (savedName) document.getElementById('username').value = savedName;


        function startLobbyLogic() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');

            const userRef = ref(db, `rooms/${ROOM_ID}/players/${myName}`);
            update(userRef, { status: "online", role: "undecided" });
            
            setupLobby();
        }

        function setupLobby() {
            onValue(ref(db, `rooms/${ROOM_ID}/players`), (snap) => {
                const data = snap.val() || {};
                currentPlayers = Object.keys(data);
                document.getElementById('player-count').textContent = currentPlayers.length;
                
                const list = document.getElementById('player-list');
                list.innerHTML = currentPlayers.map(p => `<li>${p}</li>`).join('');
                
                checkReady();
            });

            onValue(ref(db, `rooms/${ROOM_ID}/status`), (snap) => {
                if (snap.val() === 'playing') {
                    const myRoleRef = ref(db, `rooms/${ROOM_ID}/players/${myName}/role`);
                    get(myRoleRef).then((roleSnap) => {
                        const r = roleSnap.val();
                        if (r && r !== "undecided") {
                            window.location.href = `game.html?name=${encodeURIComponent(myName)}`;
                        }
                    });
                }
            });
        }

        // å…¥åŠ›å€¤ãŒå¤‰ã‚ã£ãŸã‚‰ã™ãã«ãƒã‚§ãƒƒã‚¯ï¼ˆï¼†ä¿å­˜ã—ãŸã„å ´åˆã¯ã“ã“ã§ã‚‚saveSettingsã‚’å‘¼ã¹ã‚‹ï¼‰
        const inputs = document.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            input.addEventListener('change', checkReady);
        });

        function checkReady() {
            const w = parseInt(document.getElementById('role-werewolf').value) || 0;
            const s = parseInt(document.getElementById('role-seer').value) || 0;
            const t = parseInt(document.getElementById('role-thief').value) || 0;
            const v = parseInt(document.getElementById('role-villager').value) || 0;
            const total = w + s + t + v;
            
            const btn = document.getElementById('start-btn');
            if (currentPlayers.length > 0 && total === currentPlayers.length + 2) {
                document.getElementById('status-msg').textContent = "æº–å‚™OK!";
                btn.disabled = false;
                btn.style.backgroundColor = "#ff9800";
            } else {
                document.getElementById('status-msg').textContent = `ã‚«ãƒ¼ãƒ‰æšæ•°ãŒåˆã„ã¾ã›ã‚“ (ç¾åœ¨${total}æš / å¿…è¦${currentPlayers.length+2}æš)`;
                btn.disabled = true;
                btn.style.backgroundColor = "#ccc";
            }
        }

        document.getElementById('start-btn').addEventListener('click', () => {
            // â˜…è¿½åŠ : ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«è¨­å®šã‚’ä¿å­˜ã™ã‚‹
            saveSettings();

            const gameTime = parseInt(document.getElementById('conf-time').value) || 180;
            let deck = [];
            deck = deck.concat(Array(parseInt(document.getElementById('role-werewolf').value)).fill('äººç‹¼'));
            deck = deck.concat(Array(parseInt(document.getElementById('role-seer').value)).fill('å ã„å¸«'));
            deck = deck.concat(Array(parseInt(document.getElementById('role-thief').value)).fill('æ€ªç›—'));
            deck = deck.concat(Array(parseInt(document.getElementById('role-villager').value)).fill('æ‘äºº'));

            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }

            const updates = {};
            currentPlayers.forEach((player, index) => {
                const roleName = deck[index];
                let teamId = 0;
                if (roleName === 'äººç‹¼') teamId = 1;
                updates[`players/${player}/role`] = roleName;
                updates[`players/${player}/original_role`] = roleName;
                updates[`players/${player}/team`] = teamId;
                updates[`players/${player}/actDone`] = null; 
                updates[`players/${player}/seenResult`] = null;
            });

            updates[`centerCards`] = [deck[deck.length-2], deck[deck.length-1]];
            updates[`gameTime`] = gameTime;
            updates[`votes`] = null;
            updates[`status`] = "playing"; 

            update(ref(db, `rooms/${ROOM_ID}`), updates);
        });

        // --- â˜…è¨­å®šä¿å­˜ãƒ»èª­è¾¼ãƒ­ã‚¸ãƒƒã‚¯ ---
        function saveSettings() {
            const settings = {
                time: document.getElementById('conf-time').value,
                werewolf: document.getElementById('role-werewolf').value,
                seer: document.getElementById('role-seer').value,
                thief: document.getElementById('role-thief').value,
                villager: document.getElementById('role-villager').value
            };
            localStorage.setItem('werewolf_settings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('werewolf_settings');
            if (saved) {
                try {
                    const s = JSON.parse(saved);
                    if(s.time) document.getElementById('conf-time').value = s.time;
                    if(s.werewolf) document.getElementById('role-werewolf').value = s.werewolf;
                    if(s.seer) document.getElementById('role-seer').value = s.seer;
                    if(s.thief) document.getElementById('role-thief').value = s.thief;
                    if(s.villager) document.getElementById('role-villager').value = s.villager;
                } catch(e) {
                    console.error("è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e);
                }
            }
        }
    </script>
</body>
</html>
