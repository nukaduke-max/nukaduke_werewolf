<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¯ãƒ³ãƒŠã‚¤ãƒˆäººç‹¼ï¼ˆãƒ­ãƒ“ãƒ¼æ©Ÿèƒ½ä»˜ãï¼‰</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* å…±é€šãƒ‘ãƒ¼ãƒ„ */
        input, button, select { font-size: 16px; padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; }
        button.secondary { background-color: #777; }
        button.danger { background-color: #ff4444; margin-top: 20px; }
        .hidden { display: none; }
        
        /* ã‚¨ãƒªã‚¢ã”ã¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .section { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; background: #fafafa; }
        .section h3 { margin-top: 0; font-size: 1.1em; border-bottom: 2px solid #ddd; padding-bottom: 5px; }

        /* ãƒãƒ£ãƒƒãƒˆ */
        #chat-history { height: 150px; overflow-y: scroll; border: 1px solid #ccc; background: #fff; text-align: left; padding: 10px; margin-bottom: 10px; font-size: 14px; }
        .chat-msg { margin-bottom: 4px; border-bottom: 1px dotted #eee; }
        .chat-name { font-weight: bold; color: #555; }

        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .setting-row label { flex: 1; text-align: left; }
        .setting-row input { width: 60px; text-align: center; }
        .total-check { font-weight: bold; color: blue; }
        .total-check.error { color: red; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆ */
        #player-list { list-style: none; padding: 0; }
        #player-list li { background: #e8f5e9; margin: 3px 0; padding: 8px; border-radius: 4px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸº ãƒ¯ãƒ³ãƒŠã‚¤ãƒˆäººç‹¼</h1>

        <div id="login-screen">
            <p>åå‰ã¨åˆè¨€è‘‰ã‚’å…¥ã‚Œã¦ã­</p>
            <input type="text" id="username" placeholder="åå‰ (ä¾‹: ãƒãƒ)">
            <input type="password" id="password" placeholder="åˆè¨€è‘‰">
            <button id="login-btn">å…¥å®¤ã™ã‚‹</button>
            <p id="error-msg" style="color:red;"></p>
        </div>

        <div id="lobby-screen" class="hidden">
            <div class="section">
                <h3>ğŸ‘¥ å‚åŠ è€… (<span id="player-count">0</span>äºº)</h3>
                <ul id="player-list"></ul>
            </div>

            <div class="section">
                <h3>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h3>
                <div id="chat-history"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="flex:1;">
                    <button id="chat-send" style="width:60px;">é€ä¿¡</button>
                </div>
            </div>

            <div class="section">
                <h3>âš™ï¸ ã‚²ãƒ¼ãƒ è¨­å®š</h3>
                <div class="setting-row">
                    <label>â± è­°è«–æ™‚é–“ (ç§’)</label>
                    <input type="number" id="conf-time" value="180">
                </div>
                <hr>
                <p style="font-size:0.9em; margin:5px 0;">å½¹è·ã®æ•° (åˆè¨ˆ: <span id="role-total">0</span>)</p>
                <div class="setting-row"><label>ğŸº äººç‹¼</label><input type="number" class="role-input" id="role-werewolf" data-role="werewolf" value="2"></div>
                <div class="setting-row"><label>ğŸ”® å ã„å¸«</label><input type="number" class="role-input" id="role-seer" data-role="seer" value="1"></div>
                <div class="setting-row"><label>ğŸ± æ€ªç›—</label><input type="number" class="role-input" id="role-thief" data-role="thief" value="1"></div>
                <div class="setting-row"><label>ğŸ‘± æ‘äºº</label><input type="number" class="role-input" id="role-villager" data-role="villager" value="0"></div>
                
                <p id="match-status" class="total-check">è¨­å®šå¾…ã¡...</p>
            </div>

            <button id="start-game-btn" class="secondary" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹ (æº–å‚™ä¸­)</button>
            
            <button id="reset-btn" class="danger">è§£æ•£ãƒ»ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, push, onChildAdded, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // â˜…è¨­å®š: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›¸ãæ›ãˆ
        const PASSWORD = "1234";
        const ROOM_ID = "my_private_room";

        const firebaseConfig = {
            apiKey: "AIzaSyCZZlMXREYtPTFXMTrjtATsa1xShWmZIZI",
            authDomain: "werewolf-756e4.firebaseapp.com",
            databaseURL: "https://werewolf-756e4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "werewolf-756e4",
            storageBucket: "werewolf-756e4.firebasestorage.app",
            messagingSenderId: "935198400486",
            appId: "1:935198400486:web:4ad43bbc49adac97a6c027",
            measurementId: "G-Q7LBVYBN3Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // å¤‰æ•°
        let myName = "";
        let currentPlayers = 0;

        // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
        document.getElementById('login-btn').addEventListener('click', () => {
            const name = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value;
            if (!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ã­");
            if (pass !== PASSWORD) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");

            myName = name;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            
            joinRoom();
        });

        function joinRoom() {
            // å‚åŠ ç™»éŒ²
            const myRef = ref(db, `rooms/${ROOM_ID}/players/${myName}`);
            set(myRef, { status: "online", role: "undecided" });
            onDisconnect(myRef).remove();

            setupListeners();
        }

        // --- ãƒ‡ãƒ¼ã‚¿ç›£è¦– (ãƒªã‚¹ãƒŠãƒ¼) ---
        function setupListeners() {
            // 1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ç›£è¦–
            onValue(ref(db, `rooms/${ROOM_ID}/players`), (snap) => {
                const list = document.getElementById('player-list');
                list.innerHTML = "";
                const data = snap.val() || {};
                currentPlayers = Object.keys(data).length;
                document.getElementById('player-count').textContent = currentPlayers;

                Object.keys(data).forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name + (name === myName ? " (è‡ªåˆ†)" : "");
                    list.appendChild(li);
                });
                checkGameReady(); // äººæ•°ãƒã‚§ãƒƒã‚¯
            });

            // 2. è¨­å®šç›£è¦– (èª°ã‹ãŒè¨­å®šã‚’å¤‰ãˆãŸã‚‰ç”»é¢ã«åæ˜ )
            onValue(ref(db, `rooms/${ROOM_ID}/settings`), (snap) => {
                const val = snap.val();
                if (val) {
                    if(val.time) document.getElementById('conf-time').value = val.time;
                    if(val.roles) {
                        document.getElementById('role-werewolf').value = val.roles.werewolf || 0;
                        document.getElementById('role-seer').value = val.roles.seer || 0;
                        document.getElementById('role-thief').value = val.roles.thief || 0;
                        document.getElementById('role-villager').value = val.roles.villager || 0;
                    }
                }
                checkGameReady();
            });

            // 3. ãƒãƒ£ãƒƒãƒˆå—ä¿¡
            onChildAdded(ref(db, `rooms/${ROOM_ID}/chat`), (snap) => {
                const msg = snap.val();
                const div = document.createElement('div');
                div.className = "chat-msg";
                div.innerHTML = `<span class="chat-name">${msg.name}:</span> ${msg.text}`;
                const history = document.getElementById('chat-history');
                history.appendChild(div);
                history.scrollTop = history.scrollHeight; // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            });
        }

        // --- è¨­å®šå¤‰æ›´ã®é€ä¿¡ ---
        // æ•°å­—ã‚’å¤‰ãˆãŸã‚‰ã™ãã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°ã™ã‚‹
        const settingsInputs = document.querySelectorAll('.role-input, #conf-time');
        settingsInputs.forEach(input => {
            input.addEventListener('change', () => {
                const settings = {
                    time: parseInt(document.getElementById('conf-time').value),
                    roles: {
                        werewolf: parseInt(document.getElementById('role-werewolf').value),
                        seer: parseInt(document.getElementById('role-seer').value),
                        thief: parseInt(document.getElementById('role-thief').value),
                        villager: parseInt(document.getElementById('role-villager').value)
                    }
                };
                update(ref(db, `rooms/${ROOM_ID}/settings`), settings);
            });
        });

        // --- ãƒãƒ£ãƒƒãƒˆé€ä¿¡ ---
        document.getElementById('chat-send').addEventListener('click', sendChat);
        // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ã‚‚é€ä¿¡
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
             if (e.key === 'Enter') sendChat(); 
        });

        function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            push(ref(db, `rooms/${ROOM_ID}/chat`), {
                name: myName,
                text: text,
                timestamp: Date.now()
            });
            input.value = "";
        }

        // --- äººæ•°ã¨å½¹è·æ•°ã®ãƒã‚§ãƒƒã‚¯ ---
        function checkGameReady() {
            // ãƒ¯ãƒ³ãƒŠã‚¤ãƒˆäººç‹¼ã¯ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•° + 2æšã€ã®ã‚«ãƒ¼ãƒ‰ãŒå¿…è¦
            const w = parseInt(document.getElementById('role-werewolf').value) || 0;
            const s = parseInt(document.getElementById('role-seer').value) || 0;
            const t = parseInt(document.getElementById('role-thief').value) || 0;
            const v = parseInt(document.getElementById('role-villager').value) || 0;
            
            const totalCards = w + s + t + v;
            document.getElementById('role-total').textContent = totalCards;

            const statusText = document.getElementById('match-status');
            const startBtn = document.getElementById('start-game-btn');

            // å¿…è¦ãªã‚«ãƒ¼ãƒ‰æšæ•°ã¯ã€é€šå¸¸ã¯å‚åŠ äººæ•°+2æšï¼ˆå ´ã«2æšä½™ã‚‹ï¼‰
            const needed = currentPlayers + 2;

            if (currentPlayers === 0) {
                statusText.textContent = "å‚åŠ è€…å¾…ã¡...";
                statusText.className = "total-check";
                startBtn.disabled = true;
            } else if (totalCards === needed) {
                statusText.textContent = `OK! (å‚åŠ è€…${currentPlayers}äºº + ä½™ã‚Š2æš)`;
                statusText.className = "total-check";
                startBtn.disabled = false;
                startBtn.textContent = "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼";
                startBtn.style.backgroundColor = "#ff9800"; // è‰²ã‚’å¤‰ãˆã¦ç›®ç«‹ãŸã›ã‚‹
            } else {
                statusText.textContent = `ã‚«ãƒ¼ãƒ‰ãŒåˆã„ã¾ã›ã‚“ (ç¾åœ¨${totalCards}æš / å¿…è¦${needed}æš)`;
                statusText.className = "total-check error";
                startBtn.disabled = true;
                startBtn.textContent = "è¨­å®šèª¿æ•´ä¸­...";
                startBtn.style.backgroundColor = "#777";
            }
        }

        // è§£æ•£
        document.getElementById('reset-btn').addEventListener('click', () => {
            if(confirm("å…¨å“¡é€€å‡ºã•ã›ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                remove(ref(db, `rooms/${ROOM_ID}`));
                location.reload();
            }
        });
        
    </script>
</body>
</html>
