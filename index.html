<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ¯ãƒ³ãƒŠã‚¤ãƒˆäººç‹¼ï¼ˆãƒ­ãƒ“ãƒ¼ï¼‰</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, button { font-size: 16px; padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px; }
        .hidden { display: none; }
        .setting-row { margin: 5px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        #player-list li {
            padding: 8px; border-bottom: 1px solid #eee; text-align: left;
            display: flex; justify-content: space-between;
        }
        .status-badge { font-size: 0.8em; padding: 2px 6px; border-radius: 4px; }
        .status-lobby { background: #e8f5e9; color: #2e7d32; font-weight: bold; }
        .status-away { background: #fff3e0; color: #ef6c00; }

                /* --- PCãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ã®èª¿æ•´ --- */
        /* ç”»é¢å¹…ãŒ768pxä»¥ä¸Šï¼ˆã‚¹ãƒãƒ›ä»¥å¤–ï¼‰ã®æ™‚ã ã‘é©ç”¨ã•ã‚Œã¾ã™ */
        @media (min-width: 768px) {
            body { 
                font-size: 24px; /* åŸºæœ¬ã®æ–‡å­—ã‚’å¤§ãã */
            }
            input, button, select { 
                font-size: 24px !important; /* å…¥åŠ›æ¬„ã‚„ãƒœã‚¿ãƒ³ã‚‚å¤§ãã */
                padding: 15px; /* ä½™ç™½ã‚‚ãŸã£ã·ã‚Šã¨ */
            }
            .container, .card, .area-box { 
                max-width: 800px; /* æ ã®å¹…ã‚’å°‘ã—åºƒã’ã‚‹ */
            }
            #winner-banner {
                font-size: 3em; /* çµæœç”»é¢ã®ãƒãƒŠãƒ¼ã‚’ã•ã‚‰ã«å·¨å¤§ã« */
            }
            /* ã‚¿ã‚¤ãƒˆãƒ«ãªã©ã‚‚å¤§ãã */
            h1 { font-size: 3em; }
            h2 { font-size: 2.5em; }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸº ãƒ­ãƒ“ãƒ¼</h1>

        <div id="login-screen">
            <input type="text" id="username" placeholder="åå‰ (ä¾‹: ãƒãƒ)">
            <input type="password" id="password" placeholder="åˆè¨€è‘‰">
            <button id="login-btn">å…¥å®¤</button>
        </div>

        <div id="lobby-screen" class="hidden">
            <p>å‚åŠ è€…: <span id="player-count">0</span>äºº</p>
            <ul id="player-list"></ul>
            <hr>
            <h3>ã‚²ãƒ¼ãƒ è¨­å®š</h3>
            
            <div class="setting-row">
                <label>â± è­°è«–æ™‚é–“ (ç§’)</label>
                <input type="number" id="conf-time" class="sync-setting" value="180" style="width:80px;">
            </div>

            <hr>
            <div class="setting-row">ğŸºäººç‹¼ <input type="number" id="role-werewolf" class="sync-setting" value="2" style="width:50px;"></div>
            <div class="setting-row">ğŸ”®å ã„ <input type="number" id="role-seer" class="sync-setting" value="1" style="width:50px;"></div>
            <div class="setting-row">ğŸ±æ€ªç›— <input type="number" id="role-thief" class="sync-setting" value="1" style="width:50px;"></div>
            <div class="setting-row">ğŸ‘»åŠã‚Šäºº <input type="number" id="role-tanner" class="sync-setting" value="0" style="width:50px;"></div>
            <div class="setting-row">ğŸ‘±æ‘äºº <input type="number" id="role-villager" class="sync-setting" value="0" style="width:50px;"></div>
            
            <p id="status-msg">æº–å‚™ä¸­...</p>
            
            <button id="start-btn" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</button>
        </div>
    </div>

    <script type="module">
        import { db, ref, set, update, onValue, get, ROOM_ID, PASSWORD } from './config.js';

        let myName = "";
        let currentPlayers = [];
        let isUpdating = false;

        // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
        const params = new URLSearchParams(window.location.search);
        const autoLogin = params.get('auto');
        const urlName = params.get('name');

        if (autoLogin && urlName) {
            myName = urlName;
            document.getElementById('username').value = myName;
            startLobbyLogic();
        }

        document.getElementById('login-btn').addEventListener('click', () => {
            const name = document.getElementById('username').value.trim();
            if (document.getElementById('password').value !== PASSWORD) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
            if (!name) return;

            myName = name;
            localStorage.setItem('werewolf_username', myName);
            startLobbyLogic();
        });

        const savedName = localStorage.getItem('werewolf_username');
        if (savedName) document.getElementById('username').value = savedName;


        function startLobbyLogic() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');

            const userRef = ref(db, `rooms/${ROOM_ID}/players/${myName}`);
            update(userRef, { 
                status: "online", 
                role: "undecided",
                location: "lobby"
            });
            
            setupLobby();
        }

        function setupLobby() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§
            onValue(ref(db, `rooms/${ROOM_ID}/players`), (snap) => {
                const data = snap.val() || {};
                currentPlayers = Object.keys(data);
                document.getElementById('player-count').textContent = currentPlayers.length;
                
                const list = document.getElementById('player-list');
                list.innerHTML = "";

                currentPlayers.forEach(p => {
                    const pData = data[p];
                    const li = document.createElement('li');
                    
                    const isLobby = pData.location === "lobby";
                    const statusText = isLobby ? "ğŸ  æº–å‚™OK" : "ğŸ‘ï¸ ç¢ºèªä¸­...";
                    const statusClass = isLobby ? "status-lobby" : "status-away";

                    li.innerHTML = `
                        <span>${p}</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    `;
                    list.appendChild(li);
                });
                
                checkReady();
            });

            // è¨­å®šåŒæœŸ
            onValue(ref(db, `rooms/${ROOM_ID}/settings`), (snap) => {
                const s = snap.val();
                if (s) {
                    isUpdating = true;
                    if(s.time !== undefined) document.getElementById('conf-time').value = s.time;
                    if(s.werewolf !== undefined) document.getElementById('role-werewolf').value = s.werewolf;
                    if(s.seer !== undefined) document.getElementById('role-seer').value = s.seer;
                    if(s.thief !== undefined) document.getElementById('role-thief').value = s.thief;
                    if(s.tanner !== undefined) document.getElementById('role-tanner').value = s.tanner; // â˜…è¿½åŠ 
                    if(s.villager !== undefined) document.getElementById('role-villager').value = s.villager;
                    isUpdating = false;
                    checkReady();
                }
            });

            // ã‚²ãƒ¼ãƒ é–‹å§‹ç›£è¦–
            onValue(ref(db, `rooms/${ROOM_ID}/status`), (snap) => {
                if (snap.val() === 'playing') {
                    const myRoleRef = ref(db, `rooms/${ROOM_ID}/players/${myName}/role`);
                    get(myRoleRef).then((roleSnap) => {
                        const r = roleSnap.val();
                        if (r && r !== "undecided") {
                            window.location.href = `game.html?name=${encodeURIComponent(myName)}`;
                        }
                    });
                }
            });
        }

        // è¨­å®šå¤‰æ›´é€ä¿¡
        const settingInputs = document.querySelectorAll('.sync-setting');
        settingInputs.forEach(input => {
            input.addEventListener('change', () => {
                if(isUpdating) return;

                const settings = {
                    time: parseInt(document.getElementById('conf-time').value) || 180,
                    werewolf: parseInt(document.getElementById('role-werewolf').value) || 0,
                    seer: parseInt(document.getElementById('role-seer').value) || 0,
                    thief: parseInt(document.getElementById('role-thief').value) || 0,
                    tanner: parseInt(document.getElementById('role-tanner').value) || 0, // â˜…è¿½åŠ 
                    villager: parseInt(document.getElementById('role-villager').value) || 0
                };

                update(ref(db, `rooms/${ROOM_ID}/settings`), settings);
                checkReady();
            });
        });


        function checkReady() {
            const w = parseInt(document.getElementById('role-werewolf').value) || 0;
            const s = parseInt(document.getElementById('role-seer').value) || 0;
            const t = parseInt(document.getElementById('role-thief').value) || 0;
            const tan = parseInt(document.getElementById('role-tanner').value) || 0; // â˜…è¿½åŠ 
            const v = parseInt(document.getElementById('role-villager').value) || 0;
            const total = w + s + t + tan + v;
            
            const btn = document.getElementById('start-btn');
            if (currentPlayers.length > 0 && total === currentPlayers.length + 2) {
                document.getElementById('status-msg').textContent = "æº–å‚™OK!";
                btn.disabled = false;
                btn.style.backgroundColor = "#ff9800";
            } else {
                document.getElementById('status-msg').textContent = `ã‚«ãƒ¼ãƒ‰æšæ•°ãŒåˆã„ã¾ã›ã‚“ (ç¾åœ¨${total}æš / å¿…è¦${currentPlayers.length+2}æš)`;
                btn.disabled = true;
                btn.style.backgroundColor = "#ccc";
            }
        }

        document.getElementById('start-btn').addEventListener('click', () => {
            const gameTime = parseInt(document.getElementById('conf-time').value) || 180;
            
            let deck = [];
            deck = deck.concat(Array(parseInt(document.getElementById('role-werewolf').value)).fill('äººç‹¼'));
            deck = deck.concat(Array(parseInt(document.getElementById('role-seer').value)).fill('å ã„å¸«'));
            deck = deck.concat(Array(parseInt(document.getElementById('role-thief').value)).fill('æ€ªç›—'));
            deck = deck.concat(Array(parseInt(document.getElementById('role-tanner').value)).fill('åŠã‚Šäºº')); // â˜…è¿½åŠ 
            deck = deck.concat(Array(parseInt(document.getElementById('role-villager').value)).fill('æ‘äºº'));

            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }

            const updates = {};
            currentPlayers.forEach((player, index) => {
                const roleName = deck[index];
                
                // â˜…é™£å–¶è¨­å®šï¼ˆ0:æ‘äºº, 1:äººç‹¼, 2:åŠã‚Šäººï¼‰
                let teamId = 0;
                if (roleName === 'äººç‹¼') teamId = 1;
                if (roleName === 'åŠã‚Šäºº') teamId = 2; // â˜…ã“ã“ã§ãƒãƒ¼ãƒ IDã‚’è¨­å®š

                updates[`players/${player}/role`] = roleName;
                updates[`players/${player}/original_role`] = roleName;
                updates[`players/${player}/team`] = teamId;
                updates[`players/${player}/actDone`] = null; 
                updates[`players/${player}/seenResult`] = null;
                updates[`players/${player}/location`] = "game";
            });

            updates[`centerCards`] = [deck[deck.length-2], deck[deck.length-1]];
            updates[`gameTime`] = gameTime;
            updates[`votes`] = null;
            updates[`chat`] = null;
            updates[`status`] = "playing"; 

            update(ref(db, `rooms/${ROOM_ID}`), updates);
        });
    </script>
</body>
</html>
